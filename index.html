<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper â€” Telegram Mini App</title>

<!-- Telegram WebApp SDK (required) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase compat SDKs (single-file friendly) -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<style>
  :root{--bg:#020610;--card:#071425;--accent:#00e5a8;--muted:#93b6c6}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#001018,#020610);color:#d8f6f0}
  .wrap{max-width:720px;margin:12px auto;padding:14px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  #game{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
  #left{padding:12px}
  #right{padding:12px}
  .hud{display:flex;gap:10px;justify-content:space-between;margin-bottom:10px}
  .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-width:0}
  #tapBtn{width:100%;padding:16px;border-radius:12px;background:linear-gradient(180deg,#023c32,#01513f);border:0;color:#fff;font-weight:800;font-size:18px}
  .small{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
  #hackAnim{height:130px;background:#00121a;border-radius:8px;padding:10px;color:#7ef2d7;overflow:hidden;font-family:monospace}
  .line{opacity:0;transform:translateY(6px);animation:in .45s forwards}
  @keyframes in{to{opacity:1;transform:none}}
  #glitch{position:fixed;inset:0;display:none;z-index:9999;pointer-events:none}
  .glitchLayer{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,0,120,0.06), rgba(0,255,200,0.06));mix-blend-mode:screen;filter:contrast(1.2) saturate(1.2);animation:glitchAnim .8s ease-in-out}
  @keyframes glitchAnim{0%{transform:translateX(0)}50%{transform:translateX(6px) skewX(-2deg)}100%{transform:translateX(0)}}
  ol{padding-left:18px;margin:8px 0}
  .muted{color:var(--muted);font-size:13px}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071021;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);z-index:10000;max-width:92%;width:420px}
  .closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
  @media (max-width:480px){#game{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap card">
  <header>
    <div>
      <h1>ðŸ’» Hacker Tapper</h1>
      <div class="muted">Inside Telegram â€” tap, watch, invite, win.</div>
    </div>
    <div id="playerTag" class="muted">Loading...</div>
  </header>

  <div id="game" class="card">
    <div id="left">
      <div class="hud">
        <div class="stat">Balance: <strong id="balance">0</strong> TOK</div>
        <div class="stat">Score: <strong id="score">0</strong></div>
        <div class="stat">Taps: <strong id="taps">0</strong></div>
      </div>

      <div id="hackAnim" aria-hidden="false"></div>

      <button id="tapBtn">TAP TO INJECT</button>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="small" id="watchAdBtn">Watch Ad (reward)</button>
        <button class="small" id="missionsBtn">Missions</button>
        <button class="small" id="inviteBtn">Invite</button>
      </div>

      <div id="refBox" class="muted" style="margin-top:12px">Referral: <span id="refLink">-</span></div>
    </div>

    <aside id="right">
      <div>
        <h3 style="margin:0">Leaderboard</h3>
        <div id="leaderboard" style="margin-top:8px">
          <ol id="lbList"></ol>
        </div>

        <div style="margin-top:12px"><strong>Booster:</strong> <span id="boosterInfo">None</span></div>

        <div style="margin-top:12px"><strong>Recent Loot:</strong>
          <div id="lootList" class="muted" style="max-height:120px;overflow:auto"></div>
        </div>
      </div>
    </aside>
  </div>
  <div class="muted" style="margin-top:12px">Host over HTTPS. Replace config & server URLs before production.</div>
</div>

<div id="glitch"><div class="glitchLayer"></div></div>

<!-- modal container -->
<div id="modalRoot"></div>

<script>
/* ---------- CONFIG - REPLACE THESE ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.firebasestorage.app",
  messagingSenderId: "392187080052",
  appId: "1:392187080052:web:3e31391442ca1315dc1021",
  measurementId: "G-0YWTXYJ7RN"
};
const VERIFY_PLAY_URL = 'https://us-central1-YOUR_PROJECT.cloudfunctions.net/verifyPlay'; // server verify (Cloud Function)
const VERIFY_AD_URL = 'https://your-server.example.com/verifyAdReward'; // server endpoint to verify ad receipts
const BOT_USERNAME = 'YOUR_BOT_USERNAME'; // without @
const MONEYTAG_ZONE_SCRIPT = { src: '//libtl.com/sdk.js', dataset: { zone: '10199103', sdk: 'show_10199103' }, funcName: 'show_10199103' };
/* ------------------------------------------- */

/* Defensive helpers */
function $id(id){ return document.getElementById(id); }
function createNode(tag, attrs = {}){ const el = document.createElement(tag); Object.assign(el, attrs); return el; }
function showModal(title, bodyHtml){
  const m = createNode('div'); m.className='modal';
  m.innerHTML = `<div class="closeX">âœ•</div><h3>${title}</h3><div style="margin-top:8px">${bodyHtml}</div>`;
  document.getElementById('modalRoot').appendChild(m);
  m.querySelector('.closeX').onclick = ()=>m.remove();
  return m;
}

/* Initialize Firebase (compat) */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const usersColl = db.collection('users');
const lbColl = db.collection('leaderboard');

/* Telegram WebApp init */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (!tg){
  // still allow running in normal browser for testing, but warn
  console.warn('Telegram WebApp object missing. Open inside Telegram for full functionality.');
}
try { tg?.expand(); } catch(e){}

const tgUser = tg?.initDataUnsafe?.user || {};
const playerId = String(tgUser?.id || ('guest_' + Math.random().toString(36).slice(2,9)));
const playerName = (tgUser?.first_name || 'Guest');
$id('playerTag').textContent = `${playerName} â€¢ ${playerId}`;

/* referral detection (Telegram passes start_param into initDataUnsafe.start_param) */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = null;
if (startParam && startParam.startsWith('ref_')) referrerId = startParam.replace('ref_','');

/* state */
let balance = Number(localStorage.getItem('ht_balance') || 0);
let score = Number(localStorage.getItem('ht_score') || 0);
let totalTaps = Number(localStorage.getItem('ht_totalTaps') || 0);
let tapBuffer = 0;
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];

/* UI update */
function render(){
  $id('balance').textContent = balance;
  $id('score').textContent = score;
  $id('taps').textContent = totalTaps;
  $id('boosterInfo').textContent = (booster.multiplier>1 && Date.now() < booster.expiresAt) ? `x${booster.multiplier} (exp ${new Date(booster.expiresAt).toLocaleTimeString()})` : 'None';
  $id('refLink').textContent = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`;
  $id('lootList').innerHTML = recentLoot.slice().reverse().map(l=>`<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('');
}
render();

/* ensure user doc exists */
async function ensureUser(){
  const docRef = usersColl.doc(playerId);
  const snap = await docRef.get();
  if (!snap.exists){
    await docRef.set({
      playerId, username: playerName, balance, score, totalTaps,
      booster: null, referrer: referrerId || null, referral_claimed:false, createdAt: Date.now()
    });
    if (referrerId) await applyReferral(referrerId);
  } else {
    const data = snap.data();
    balance = Number(data.balance || balance);
    score = Number(data.score || score);
    totalTaps = Number(data.totalTaps || totalTaps);
    if (data.booster && data.booster.expiresAt && Date.now() < data.booster.expiresAt) booster = data.booster;
    // load recent loot
    const q = db.collection('lootHistory').where('playerId','==',playerId).orderBy('ts','desc').limit(6);
    const res = await q.get();
    recentLoot = res.docs.map(d=>d.data());
  }
  render();
}
ensureUser().catch(console.error);

/* apply referral once */
async function applyReferral(refId){
  try {
    const uRef = usersColl.doc(playerId);
    const snap = await uRef.get();
    if (!snap.exists) return;
    const data = snap.data();
    if (data.referral_claimed) return;
    await uRef.update({ referral_claimed:true });
    const newUserReward = 50;
    balance += newUserReward;
    await uRef.update({ balance });
    const refRef = usersColl.doc(refId);
    const refSnap = await refRef.get();
    if (refSnap.exists){
      const prev = Number(refSnap.data().balance || 0);
      const refReward = 100;
      await refRef.update({ balance: prev + refReward });
      await db.collection('referrals').add({ referrer: refId, referee: playerId, ts: Date.now(), refReward, newUserReward });
    }
    await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
    render();
  } catch(e){ console.error('applyReferral', e); }
}

/* persist state */
async function persist(force=false){
  localStorage.setItem('ht_balance', String(balance));
  localStorage.setItem('ht_score', String(score));
  localStorage.setItem('ht_totalTaps', String(totalTaps));
  if (tapBuffer >= 20 || force){
    tapBuffer = 0;
    try{
      await usersColl.doc(playerId).set({ playerId, username: playerName, balance, score, totalTaps, booster:(booster.multiplier>1?booster:null) }, { merge:true });
      await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
    }catch(e){ console.warn('persist error', e); }
  }
}
setInterval(()=>persist(true), 15000);

/* hack animation */
function pushLine(text){
  const el = document.createElement('div');
  el.className = 'line';
  el.textContent = text;
  hackAnimEl.appendChild(el);
  while (hackAnimEl.children.length > 6) hackAnimEl.removeChild(hackAnimEl.firstChild);
}

/* glitch */
function showGlitch(ms=800){
  const g = $id('glitch');
  g.style.display = 'block';
  setTimeout(()=> g.style.display = 'none', ms);
}

/* loot grant */
async function grantLoot(amount, reason='event'){
  balance += amount;
  recentLoot.push({ amount, reason, ts: Date.now() });
  if (recentLoot.length>12) recentLoot.shift();
  render();
  try {
    await db.collection('lootHistory').add({ playerId, amount, reason, ts: Date.now() });
    await usersColl.doc(playerId).set({ balance }, { merge:true });
    await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
  } catch(e){ console.warn('grantLoot error', e); }
}

/* booster */
async function giveBooster(mult, dur){
  booster = { multiplier: mult, expiresAt: Date.now() + dur*1000 };
  try { await usersColl.doc(playerId).set({ booster }, { merge:true }); } catch(e){ console.warn('booster write', e); }
  render();
  setTimeout(()=>{ if (Date.now() >= booster.expiresAt){ booster = { multiplier:1, expiresAt:0 }; render(); } }, dur*1000 + 200);
}

/* leader refresh */
async function refreshLeaderboard(){
  try {
    const snaps = await lbColl.orderBy('balance','desc').limit(16).get();
    lbList.innerHTML = '';
    snaps.forEach(d => {
      const dd = d.data();
      const li = document.createElement('li');
      li.textContent = `${dd.username || dd.playerId} â€” ${dd.balance}`;
      lbList.appendChild(li);
    });
  } catch(e) { console.warn('lb error', e); }
}
refreshLeaderboard();
setInterval(refreshLeaderboard, 15000);

/* main tap logic */
let sessionStart = 0, sessionTaps = 0;
const hackAnimEl = $id('hackAnim');

$id('tapBtn').addEventListener('click', async ()=>{
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++;
  totalTaps++; tapBuffer++;
  const now = Date.now();
  const mult = (booster.multiplier>1 && booster.expiresAt > now) ? booster.multiplier : 1;
  const gain = Math.round(1 * mult + Math.random()*1);
  score += gain;
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    recentLoot.push({ amount: tok, reason:'tap_reward', ts: Date.now() });
    if (recentLoot.length>12) recentLoot.shift();
  }
  render();
  pushLine(`> injected +${gain} pts`);
  if (Math.random() < 0.03) showGlitch(700);
  if (Math.random() < 0.02) { const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }
  if (totalTaps % 30 === 0){
    await onThirty();
    // verify session with server
    const durationMs = Date.now() - (sessionStart || Date.now());
    const sessionId = 'sess_' + (sessionStart || Date.now()) + '_' + Math.random().toString(36).slice(2,8);
    verifyPlay(sessionId, sessionTaps, durationMs).catch(()=>{});
    sessionStart = 0; sessionTaps = 0;
  }
  if (tapBuffer >= 20) await persist();
});

/* 30-tap stacked actions */
async function onThirty(){
  // auto-show ad, play animation, show mission, glitch, loot, booster
  const adResult = await showAdFlow(); // returns 'rewarded'|'skipped'|'failed'
  pushLine('!!! SYSTEM EVENT: 30 TAPS !!!');
  showGlitch(900);
  showMission('30_tap_event','30 taps event â€” claim your reward!');
  if (adResult === 'rewarded'){
    await giveBooster(2, 20);
    const loot = Math.floor(Math.random()*150)+50;
    await grantLoot(loot,'ad_loot');
    showModal('Reward', `Ad watched â€” Booster x2 (20s) +${loot} TOK (server verify pending).`);
  } else {
    const small = 20; await grantLoot(small,'no_ad_cons'); showModal('Notice', `Ad not available â€” you got ${small} TOK.`);
  }
}

/* show mission popup */
function showMission(id, text){
  const m = createNode('div'); m.className='modal';
  m.innerHTML = `<div class="closeX">âœ•</div><h3>Mission</h3><div style="margin-top:8px">${text}</div>
    <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
      <div class="muted">Reward: 100 TOK</div>
      <button id="claimBtn" class="small">Claim</button>
    </div>`;
  document.getElementById('modalRoot').appendChild(m);
  m.querySelector('.closeX').onclick = ()=>m.remove();
  m.querySelector('#claimBtn').onclick = async ()=>{
    try {
      const docRef = usersColl.doc(playerId);
      const snap = await docRef.get();
      const data = snap.data() || {};
      if (data.missions && data.missions[id] && data.missions[id].claimed){ alert('Already claimed'); m.remove(); return; }
      const updates = {}; updates[`missions.${id}`] = { claimed:true, ts:Date.now(), reward:100 };
      await docRef.set(updates, { merge:true });
      await grantLoot(100,'mission_claim');
      m.remove();
    } catch(e){ console.error('claim err', e); alert('Claim failed'); }
  };
}

/* Ad flow: load MoneyTag SDK lazily and call its function if present.
   Fallbacks: tg.Ad or confirm simulation.
*/
let moneytagLoaded = false;
function injectMoneyTag(){
  if (moneytagLoaded) return;
  const s = document.createElement('script');
  s.src = MONEYTAG_ZONE_SCRIPT.src;
  s.id = 'moneytag-sdk';
  // add dataset attributes if sdk requires them
  s.dataset.zone = MONEYTAG_ZONE_SCRIPT.dataset.zone;
  s.dataset.sdk = MONEYTAG_ZONE_SCRIPT.dataset.sdk;
  s.onload = ()=>{ moneytagLoaded = true; console.log('MoneyTag SDK loaded'); };
  s.onerror = ()=>{ console.warn('MoneyTag SDK failed to load'); };
  document.head.appendChild(s);
}

/* Call this to show monetag ad (if SDK exposes window function), else tg.Ad, else simulate */
async function showAdFlow(){
  // ensure SDK injected (do it lazily)
  injectMoneyTag();
  // small delay to allow load in real env
  await new Promise(r=>setTimeout(r, 500));

  // MoneyTag global function name may vary â€” using option from initial script: show_10199103
  try {
    if (typeof window.show_10199103 === 'function'){
      try { window.show_10199103(); } catch(e){ console.warn('moneytag call failed', e); }
      // best practice: rely on Monetag webhook for server verification rather than client receipts
      // optimistic return:
      return 'rewarded';
    }
  } catch(e){ console.warn(e); }

  // Try Telegram's ad API
  try {
    if (tg && tg.Ad && typeof tg.Ad.show === 'function'){
      const res = await tg.Ad.show(); // may return 'rewarded' or others
      if (res === 'rewarded' || res === true) {
        // optional: call server to verify if platform provides a receipt
        await callVerifyAdServer({ playerId, source:'tg' }).catch(()=>{});
        return 'rewarded';
      }
      return 'skipped';
    }
  } catch(e){ console.warn('tg.Ad error', e); }

  // fallback: simulate for testing
  const ok = confirm('Simulate ad (OK = watched & rewarded)?');
  if (ok) { await callVerifyAdServer({ playerId, simulated:true }).catch(()=>{}); return 'rewarded'; }
  return 'skipped';
}

/* server verification helpers */
async function callVerifyAdServer(payload){
  try { await fetch(VERIFY_AD_URL, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) }); }
  catch(e){ console.warn('callVerifyAdServer failed', e); }
}
async function verifyPlay(sessionId, taps, durationMs){
  try {
    const res = await fetch(VERIFY_PLAY_URL, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ playerId, taps, durationMs, sessionId, username: playerName }) });
    if (!res.ok){ console.warn('verifyPlay rejected', await res.text()); return false; }
    const data = await res.json();
    if (data && data.ok && data.tokensAward){
      // sync balance from server user doc
      const snap = await usersColl.doc(playerId).get();
      if (snap.exists){ balance = Number(snap.data().balance || balance); render(); }
      return true;
    }
    return false;
  } catch(e){ console.warn('verifyPlay error', e); return false; }
}

/* small helper to create nodes */
function createNode(tag){ return document.createElement(tag); }

/* manual UI controls */
$id('watchAdBtn').addEventListener('click', async ()=>{ const r = await showAdFlow(); if (r==='rewarded'){ await grantLoot(50,'manual_ad'); alert('Ad rewarded 50 TOK (server verify)'); } else alert('Ad skipped/unavailable'); });
$id('missionsBtn').addEventListener('click', ()=>showMission('manual1','Manual mission: claim 25 TOK'));
$id('inviteBtn').addEventListener('click', ()=>{ const link = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`; navigator.clipboard?.writeText(link).then(()=>alert('Referral link copied'), ()=>alert(link)); });

/* persist & unload */
window.addEventListener('beforeunload', ()=>persist(true));
setInterval(()=>{ if (tapBuffer>0) persist(); }, 5000);

/* Pre-inject MoneyTag after Telegram signals ready to reduce blocking risk */
try {
  // If Telegram is present, wait a short time after init then inject
  if (tg) {
    tg.onEvent && tg.onEvent('themeChanged', ()=>{}); // noop to ensure tg is ready
    setTimeout(()=>injectMoneyTag(), 800);
  } else {
    // still inject for browser testing
    setTimeout(()=>injectMoneyTag(), 800);
  }
} catch(e){ console.warn('inject schedule error', e); }

</script>
</body>
</html>  .terminalLine{opacity:0;transform:translateY(6px);animation:flyIn .45s forwards}
  @keyframes flyIn{to{opacity:1;transform:none}}
  #glitch{position:fixed;inset:0;pointer-events:none;display:none;align-items:center;justify-content:center;z-index:9999}
  .glitchBox{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,0,120,0.06), rgba(0,255,200,0.06));backdrop-filter:contrast(1.2) saturate(1.2);mix-blend-mode:screen;animation:glitchPulse .8s ease-in-out}
  @keyframes glitchPulse{0%{transform:skewX(0) translateX(0)}50%{transform:skewX(-2deg) translateX(6px)}100%{transform:skewX(0) translateX(0)}}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071021;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);z-index:10000;max-width:90%;width:420px}
  .modal h3{margin:0 0 8px 0}
  .modal .row{display:flex;justify-content:space-between;gap:8px;margin-top:10px}
  .closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:420px){
    #gameArea{grid-template-columns:1fr;padding:8px}
    #tapBtn{font-size:20px;padding:22px}
    .wrap{padding:8px}
  }
</style>
</head>
<body>
<div class="wrap panel">
  <header>
    <div>
      <h1>ðŸ’» Hacker Tapper</h1>
      <div class="muted">Tap to hack, watch ads, invite friends, get loot.</div>
    </div>
    <div class="muted" id="playerPane">Loading...</div>
  </header>

  <div id="gameArea">
    <div id="left" class="panel">
      <div class="hud">
        <div class="stat">Balance: <strong id="balance">0</strong> TOK</div>
        <div class="stat">Score: <strong id="score">0</strong></div>
        <div class="stat">Taps: <strong id="taps">0</strong></div>
      </div>

      <div id="hackAnim" aria-hidden="false"></div>

      <button id="tapBtn">TAP TO INJECT</button>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="small" id="showAdBtn">Watch Ad (Reward)</button>
        <button class="small" id="claimMissionBtn">Missions</button>
        <button class="small" id="openInvitesBtn">Invite</button>
      </div>

      <div id="refBox" class="muted">Referral: <span id="refLink">-</span></div>
    </div>

    <aside id="right" class="panel">
      <div>
        <h3 style="margin:0">Leaderboard</h3>
        <div id="leaderboard">
          <ol id="lbList"></ol>
        </div>
        <div style="margin-top:12px">
          <strong>Booster:</strong> <span id="boosterInfo">None</span>
        </div>
        <div style="margin-top:12px">
          <strong>Recent Loot:</strong>
          <div id="lootList" class="muted" style="max-height:120px;overflow:auto"></div>
        </div>
      </div>
    </aside>
  </div>

  <footer>Replace Firebase config, server URLs and BOT_USERNAME before production.</footer>
</div>

<div id="glitch"><div class="glitchBox"></div></div>
<div id="modalContainer" style="display:none"></div>

<script>
/*
Full single-file game code.
Replace placeholders below:
  - FIREBASE_CONFIG fields
  - VERIFY_PLAY_URL (Cloud Function URL)
  - VERIFY_AD_URL (server verify ad receipt)
  - BOT_USERNAME
Notes:
  - Server must implement /verifyPlay and /verifyAdReward endpoints.
  - MoneyTag SDK script included at top sets window.show_10199103() â€” used here.
*/

// ---------------- CONFIG - REPLACE THESE ----------------
const VERIFY_PLAY_URL = 'https://us-central1-YOUR_PROJECT.cloudfunctions.net/verifyPlay'; // your verifyPlay function
const VERIFY_AD_URL = 'https://your-server.example.com/verifyAdReward'; // your server verify ad endpoint
const firebaseConfig = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.firebasestorage.app",
  messagingSenderId: "392187080052",
  appId: "1:392187080052:web:3e31391442ca1315dc1021",
  measurementId: "G-0YWTXYJ7RN"
};
const BOT_USERNAME = 'comhash_bot'; // without @
// --------------------------------------------------------

/* Initialize Telegram WebApp */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg && tg.expand) try { tg.expand(); } catch(e){}
const tgUser = tg?.initDataUnsafe?.user || {};
const playerId = String(tgUser?.id || ('guest_' + Math.random().toString(36).slice(2,9)));
const playerName = (tgUser?.first_name || 'Guest');
document.getElementById('playerPane').textContent = `${playerName} â€¢ ${playerId}`;

/* Read start_param for referral (Telegram passes it) */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = null;
if (startParam && startParam.startsWith('ref_')) referrerId = startParam.replace('ref_','');

/* Firebase init (compat) */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const usersColl = db.collection('users');
const lbColl = db.collection('leaderboard');

/* UI references */
const balanceEl = document.getElementById('balance');
const scoreEl = document.getElementById('score');
const tapsEl = document.getElementById('taps');
const hackAnimEl = document.getElementById('hackAnim');
const lbListEl = document.getElementById('lbList');
const refLinkEl = document.getElementById('refLink');
const boosterInfoEl = document.getElementById('boosterInfo');
const lootListEl = document.getElementById('lootList');

/* Local state */
let balance = Number(localStorage.getItem('ht_balance') || 0);
let score = Number(localStorage.getItem('ht_score') || 0);
let totalTaps = Number(localStorage.getItem('ht_totalTaps') || 0);
let tapBuffer = 0;
let booster = { multiplier: 1, expiresAt: 0 };
let lastLoot = [];

/* Render UI */
function renderUI(){
  balanceEl.textContent = balance;
  scoreEl.textContent = score;
  tapsEl.textContent = totalTaps;
  boosterInfoEl.textContent = (booster.multiplier>1 && Date.now() < booster.expiresAt) ? `x${booster.multiplier} (expires ${new Date(booster.expiresAt).toLocaleTimeString()})` : 'None';
  refLinkEl.textContent = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`;
  lootListEl.innerHTML = lastLoot.slice().reverse().map(l => `<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('');
}
renderUI();

/* Ensure user doc exists and sync initial data */
async function ensureUserDoc(){
  const ref = usersColl.doc(playerId);
  const snap = await ref.get();
  if (!snap.exists){
    await ref.set({
      playerId, username: playerName, balance, score, totalTaps,
      booster: null, referrer: referrerId || null, referral_reward_claimed: false, createdAt: Date.now()
    });
    if (referrerId) await applyReferralIfEligible(referrerId);
  } else {
    const data = snap.data();
    balance = Number(data.balance || balance);
    score = Number(data.score || score);
    totalTaps = Number(data.totalTaps || totalTaps);
    if (data.booster && data.booster.expiresAt && Date.now() < data.booster.expiresAt) booster = data.booster;
    else booster = { multiplier:1, expiresAt:0 };
    const lootSnap = await db.collection('lootHistory').where('playerId','==',playerId).orderBy('ts','desc').limit(6).get();
    lastLoot = lootSnap.docs.map(d => d.data());
  }
  renderUI();
}
ensureUserDoc().catch(console.error);

/* Apply referral reward once (server-side should validate too) */
async function applyReferralIfEligible(refId){
  try {
    const userRef = usersColl.doc(playerId);
    const snap = await userRef.get();
    if (!snap.exists) return;
    const data = snap.data();
    if (data.referral_reward_claimed) return;
    await userRef.update({ referral_reward_claimed: true });
    const newUserReward = 50;
    balance += newUserReward;
    await userRef.update({ balance });
    const refRef = usersColl.doc(refId);
    const refSnap = await refRef.get();
    if (refSnap.exists){
      const prev = Number(refSnap.data().balance || 0);
      const refReward = 100;
      await refRef.update({ balance: prev + refReward });
      await db.collection('referrals').add({ referrer: refId, referee: playerId, ts: Date.now(), refReward, newUserReward });
    }
    await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
    renderUI();
  } catch(e) { console.error('applyReferral', e); }
}

/* Persist local state periodically / when buffer full */
async function persistState(force=false){
  localStorage.setItem('ht_balance', String(balance));
  localStorage.setItem('ht_score', String(score));
  localStorage.setItem('ht_totalTaps', String(totalTaps));
  if (tapBuffer >= 20 || force){
    tapBuffer = 0;
    try{
      await usersColl.doc(playerId).set({ playerId, username: playerName, balance, score, totalTaps, booster: (booster.multiplier>1?booster:null) }, { merge:true });
      await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
    } catch(e){ console.warn('persist error', e); }
  }
}
setInterval(()=>persistState(true), 15000);

/* Tap handler + session */
const tapBtn = document.getElementById('tapBtn');
tapBtn.addEventListener('click', onTap);
let sessionStart = 0, sessionTaps = 0;

function playHackAnimation(text){
  const line = document.createElement('div');
  line.className = 'terminalLine';
  line.textContent = text || `> injected ${Math.floor(Math.random()*9999)}`;
  hackAnimEl.appendChild(line);
  while (hackAnimEl.children.length > 6) hackAnimEl.removeChild(hackAnimEl.firstChild);
}

async function onTap(){
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++;
  totalTaps++; tapBuffer++;
  const now = Date.now();
  const activeMultiplier = (booster.multiplier>1 && booster.expiresAt > now) ? booster.multiplier : 1;
  const gain = Math.round(1 * activeMultiplier + Math.random()*1);
  score += gain;
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    lastLoot.push({ amount: tok, reason: 'tap_reward', ts: Date.now() });
    if (lastLoot.length>12) lastLoot.shift();
  }
  renderUI();
  playHackAnimation(`> injected +${gain} pts`);
  if (Math.random() < 0.03) triggerGlitch(800);
  if (Math.random() < 0.02) { const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }
  if (totalTaps % 30 === 0){
    await onThirtyTapTrigger();
    const durationMs = Date.now() - (sessionStart || Date.now());
    const sessionId = 'sess_' + (sessionStart || Date.now()) + '_' + Math.random().toString(36).slice(2,8);
    verifyPlayWithServer(sessionId, sessionTaps, durationMs).catch(()=>{});
    sessionStart = 0; sessionTaps = 0;
  }
  if (tapBuffer >= 20) await persistState();
}

/* 30-tap stacked action */
async function onThirtyTapTrigger(){
  const adRes = await showRewardedAd();
  playHackAnimation('!!! SYSTEM EVENT: 30 TAPS !!!');
  triggerGlitch(900);
  showMissionPopup('30_tap_event','Complete the 30-tap event to claim the mission reward.');
  if (adRes === 'rewarded'){
    await grantBooster(2,20);
    const lootAmt = Math.floor(Math.random()*150)+50;
    await grantLoot(lootAmt,'ad_reward_loot');
    showModal('Reward',`Ad watched â€” Booster x2 for 20s and +${lootAmt} TOK (server verify pending).`);
  } else {
    const small = 20; await grantLoot(small,'no_ad_consolation'); showModal('Notice',`Ad unavailable â€” you received ${small} TOK.`);
  }
}

/* Show rewarded ad: MoneyTag SDK provides window.show_10199103() per your script.
   Fallbacks included. Returns 'rewarded'|'skipped'|'failed' */
async function showRewardedAd(){
  try {
    // MoneyTag global function (from script) â€” call it if present
    if (typeof window.show_10199103 === 'function'){
      // The SDK may not return a promise; it may trigger a callback. Here we assume synchronous trigger.
      // If your Monetag SDK provides a callback or promise, adjust to handle response/receipt.
      try { window.show_10199103(); } catch(e){ console.warn('moneytag call error', e); }
      // We don't get a direct receipt here in this generic form. Server-side verification via webhook is recommended.
      // For optimistic UI, we return 'rewarded' and then call server verify route separately if you receive a receipt via webhook.
      // If your SDK gives a callback/receipt, use it to call callVerifyAdServer(receipt).
      return 'rewarded';
    }
  } catch(e){ console.warn('moneytag error', e); }

  // Next, try tg.Ad (Telegram WebApp ad API)
  try {
    if (tg && tg.Ad && typeof tg.Ad.show === 'function'){
      const r = await tg.Ad.show();
      if (r === 'rewarded' || r === true) { await callVerifyAdServer({ playerId, note:'tg_ad_reward' }).catch(()=>{}); return 'rewarded'; }
      return 'skipped';
    }
  } catch(e){ console.warn('tg.Ad.show err', e); }

  // simulate (development)
  const ok = confirm('Simulate rewarded ad? OK => rewarded');
  if (ok) { await callVerifyAdServer({ playerId, simulated:true }).catch(()=>{}); return 'rewarded'; }
  return 'skipped';
}

/* Send ad receipt / event to server for verification (implement server-side) */
async function callVerifyAdServer(payload){
  try {
    await fetch(VERIFY_AD_URL, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
  } catch(e){ console.warn('callVerifyAdServer error', e); }
}

/* Verify play session with server (anti-cheat). Server should credit tokens and return result. */
async function verifyPlayWithServer(sessionId, taps, durationMs){
  try {
    const payload = { playerId, taps, durationMs, sessionId, username: playerName };
    const res = await fetch(VERIFY_PLAY_URL, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) { console.warn('verifyPlay rejected', await res.text()); return false; }
    const data = await res.json();
    if (data && data.ok && data.tokensAward) {
      const snap = await usersColl.doc(playerId).get();
      if (snap.exists) { balance = Number(snap.data().balance || balance); renderUI(); }
      return true;
    }
    return false;
  } catch(e) { console.warn('verifyPlay error', e); return false; }
}

/* Booster - persisted to Firestore */
async function grantBooster(multiplier, durationSeconds){
  booster = { multiplier, expiresAt: Date.now() + durationSeconds*1000 };
  try { await usersColl.doc(playerId).set({ booster }, { merge:true }); } catch(e){ console.warn('grantBooster write', e); }
  renderUI();
  setTimeout(()=>{ if (Date.now() >= booster.expiresAt){ booster = { multiplier:1, expiresAt:0 }; renderUI(); } }, durationSeconds*1000 + 200);
}

/* Grant loot (persist history + user balance) */
async function grantLoot(amount, reason='event'){
  balance += amount;
  lastLoot.push({ amount, reason, ts: Date.now() });
  if (lastLoot.length>12) lastLoot.shift();
  renderUI();
  try {
    await db.collection('lootHistory').add({ playerId, amount, reason, ts: Date.now() });
    await usersColl.doc(playerId).set({ balance }, { merge:true });
    await lbColl.doc(playerId).set({ playerId, username: playerName, balance });
  } catch(e){ console.warn('grantLoot error', e); }
}

/* Glitch overlay */
function triggerGlitch(ms=800){ const g = document.getElementById('glitch'); g.style.display='flex'; setTimeout(()=>g.style.display='none', ms); }

/* Missions popup */
async function showMissionPopup(missionId, missionText){
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<div class="closeX" id="modalClose">âœ•</div><h3>Mission</h3><div>${missionText}</div>
    <div class="row"><div class="muted">Reward: 100 TOK</div><div><button id="claimMission" class="small">Claim</button></div></div>`;
  document.body.appendChild(modal);
  document.getElementById('modalClose').onclick = ()=>modal.remove();
  document.getElementById('claimMission').onclick = async ()=>{
    try {
      const docRef = usersColl.doc(playerId);
      const snap = await docRef.get(); const data = snap.data() || {};
      if (data.missions && data.missions[missionId] && data.missions[missionId].claimed){ alert('Mission already claimed.'); modal.remove(); return; }
      const updates = {}; updates[`missions.${missionId}`] = { claimed:true, ts:Date.now(), reward:100 };
      await docRef.set(updates, { merge:true });
      await grantLoot(100, 'mission_claim');
      modal.remove();
    } catch(e){ console.error('claim error', e); alert('Claim failed'); }
  };
}

/* Modal util */
function showModal(title, text){ const modal = document.createElement('div'); modal.className='modal'; modal.innerHTML = `<div class="closeX" id="mClose">âœ•</div><h3>${title}</h3><div>${text}</div>`; document.body.appendChild(modal); document.getElementById('mClose').onclick = ()=>modal.remove(); }

/* Leaderboard refresh */
async function refreshLeaderboard(){ try { const snaps = await lbColl.orderBy('balance','desc').limit(16).get(); lbListEl.innerHTML=''; snaps.forEach(d=>{ const dd=d.data(); const li = document.createElement('li'); li.textContent = `${dd.username||dd.playerId} â€” ${dd.balance}`; lbListEl.appendChild(li); }); } catch(e){ console.warn('lb error', e); } }
refreshLeaderboard(); setInterval(refreshLeaderboard, 15000);

/* Manual UI buttons */
document.getElementById('showAdBtn').addEventListener('click', async ()=>{ const res = await showRewardedAd(); if (res === 'rewarded'){ await grantLoot(50,'manual_ad'); alert('Ad rewarded 50 TOK (server verify recommended)'); } else alert('Ad skipped/unavailable'); });
document.getElementById('claimMissionBtn').addEventListener('click', ()=> showMissionPopup('manual_mission','Manual mission: claim 25 TOK'));
document.getElementById('openInvitesBtn').addEventListener('click', ()=>{ const link = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`; navigator.clipboard?.writeText(link).then(()=>alert('Referral link copied'),()=>alert(link)); });

/* Persist on unload */
window.addEventListener('beforeunload', ()=>persistState(true));
setInterval(()=>{ if (tapBuffer>0) persistState(); }, 5000);

</script>
</body>
</html>
