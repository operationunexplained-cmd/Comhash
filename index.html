<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper â€” ComHash (Telegram)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase Realtime Database (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<!-- MoneyTag (optional) -->
<script src="//libtl.com/sdk.js" data-zone="10199103" data-sdk="show_10199103" async></script>

<!-- Adexium (interstitial) -->
<script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

<style>
  :root{--bg:#020610;--card:#071425;--accent:#00e5a8;--muted:#93b6c6}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#001018,#020610);color:#d8f6f0}
  .wrap{max-width:920px;margin:12px auto;padding:14px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
  @media(max-width:780px){.grid{grid-template-columns:1fr}}
  .hud{display:flex;gap:10px;justify-content:space-between;margin-bottom:10px}
  .stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-width:0;text-align:center}
  #tapBtn{width:100%;padding:16px;border-radius:12px;background:linear-gradient(180deg,#023c32,#01513f);border:0;color:#fff;font-weight:800;font-size:18px}
  .small{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
  #hackAnim{height:140px;background:#00121a;border-radius:8px;padding:10px;color:#7ef2d7;overflow:auto;font-family:monospace}
  .lb{max-height:420px;overflow:auto}
  .muted{color:var(--muted);font-size:13px}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071021;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);z-index:10000;max-width:92%;width:420px}
  .closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
  #glitch{position:fixed;inset:0;display:none;z-index:9999;pointer-events:none}
  .glitchLayer{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,0,120,0.06), rgba(0,255,200,0.06));mix-blend-mode:screen;filter:contrast(1.2) saturate(1.2);animation:glitchAnim .8s ease-in-out}
  @keyframes glitchAnim{0%{transform:translateX(0)}50%{transform:translateX(6px) skewX(-2deg)}100%{transform:translateX(0)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 style="margin:.2rem 0">ðŸ’» Hacker Tapper â€” ComHash</h2>
        <div class="muted">Inside Telegram â€” tap, watch, invite, win.</div>
      </div>
      <div id="playerTag" class="muted">Loading...</div>
    </div>

    <div class="card grid">
      <main id="left">
        <div class="hud">
          <div class="stat">Balance:<div id="balance" style="font-weight:800;font-size:18px">0</div></div>
          <div class="stat">Score:<div id="score" style="font-weight:800;font-size:18px">0</div></div>
          <div class="stat">Taps:<div id="taps" style="font-weight:800;font-size:18px">0</div></div>
        </div>

        <div id="hackAnim" class="card">Welcome â€” press TAP to start hacking.</div>

        <button id="tapBtn">TAP TO INJECT</button>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="small" id="watchAdBtn">Watch Ad (reward)</button>
          <button class="small" id="missionsBtn">Missions</button>
          <button class="small" id="inviteBtn">Invite</button>
        </div>

        <div style="margin-top:12px" class="muted">Referral: <span id="refLink">-</span></div>
      </main>

      <aside id="right">
        <div class="card">
          <h3 style="margin:0">Leaderboard (Top 100)</h3>
          <div class="lb" id="leaderboard"><ol id="lbList"></ol></div>
          <div style="margin-top:12px"><strong>Booster:</strong> <span id="boosterInfo">None</span></div>
          <div style="margin-top:12px"><strong>Recent Loot:</strong><div id="lootList" class="muted" style="max-height:120px;overflow:auto"></div></div>
        </div>
      </aside>
    </div>

    <div id="glitch"><div class="glitchLayer"></div></div>
    <div id="modalRoot"></div>
    <div class="muted" style="margin-top:10px">Host over HTTPS. Configs inserted from your keys.</div>
  </div>

<script>
/* ================= CONFIG (your provided keys) ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.firebasestorage.app",
  messagingSenderId: "392187080052",
  appId: "1:39218708052:web:3e31391442ca1315dc1021",
  measurementId: "G-0YWTXYJ7RN"
};

const VERIFY_AD_URL   = "https://comhashgame.vercel.app/verifyAd";
const VERIFY_PLAY_URL = "https://comhashgame.vercel.app/verifyPlay";
const ADMIN_API_KEY   = "COMHASH_ADMIN_2025";

const MONEYTAG_FUNC = "show_10199103";
const MONEYTAG_ZONE = "10199103";
const ADEXIUM_WID = 'de78ddc3-cd12-4357-a6cf-8fe6c9155acc';
const BOT_USERNAME = 'comhash_bot';
/* ============================================================= */

function $id(id){ return document.getElementById(id); }
function createNode(t, a={}){ const e=document.createElement(t); Object.assign(e, a); return e; }

/* Initialize Firebase */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();
const usersRef = rdb.ref('users');
const lootRef = rdb.ref('lootHistory');

/* Telegram WebApp (strict) */
const tg = window.Telegram?.WebApp || null;
try { tg?.expand?.(); } catch(e){}
const tgUser = tg?.initDataUnsafe?.user;
if (!tgUser || !tgUser.id) {
  alert('Open inside Telegram WebApp (bot â†’ Web App). Telegram ID is required.');
  throw new Error('Telegram user required');
}
const playerId = String(tgUser.id);
const playerName = tgUser.first_name || tgUser.username || ('tg_' + playerId);
$id('playerTag').textContent = `${playerName} â€¢ ${playerId}`;

/* referral detection */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = (startParam && startParam.startsWith('ref_')) ? startParam.replace('ref_','') : null;

/* State */
let balance = 0;
let score = 0;
let totalTaps = 0;
let tapBuffer = 0;
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];

/* UI helpers */
function render(){
  $id('balance').textContent = balance;
  $id('score').textContent = score;
  $id('taps').textContent = totalTaps;
  $id('boosterInfo').textContent = (booster.multiplier>1 && Date.now() < booster.expiresAt) ? `x${booster.multiplier} (exp ${new Date(booster.expiresAt).toLocaleTimeString()})` : 'None';
  $id('refLink').textContent = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`;
  $id('lootList').innerHTML = recentLoot.slice().reverse().map(l=>`<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('');
}
function pushLine(text){ const el=createNode('div'); el.textContent=text; $id('hackAnim').appendChild(el); while($id('hackAnim').children.length>8) $id('hackAnim').removeChild($id('hackAnim').firstChild); }
function showModal(title, html){ const m=createNode('div'); m.className='modal'; m.innerHTML=`<div class="closeX">âœ•</div><h3>${title}</h3><div style="margin-top:8px">${html}</div>`; $id('modalRoot').appendChild(m); m.querySelector('.closeX').onclick = ()=>m.remove(); return m; }
function showGlitch(ms=800){ const g=$id('glitch'); g.style.display='block'; setTimeout(()=>g.style.display='none', ms); }

/* Ensure user exists (Telegram ID only) */
async function ensureUserRTDB(){
  try{
    const snap = await usersRef.child(playerId).get();
    if (!snap.exists()){
      await usersRef.child(playerId).set({
        playerId,
        username: playerName,
        balance: 0,
        score: 0,
        totalTaps: 0,
        createdAt: Date.now(),
        referrer: referrerId || null
      });
      if (referrerId) await applyReferralRTDB(referrerId);
    } else {
      const d = snap.val();
      balance = Number(d.balance || 0);
      score = Number(d.score || 0);
      totalTaps = Number(d.totalTaps || 0);
      if (d.booster && d.booster.expiresAt && Date.now() < d.booster.expiresAt) booster = d.booster;
      const lootSnap = await lootRef.orderByChild('playerId').equalTo(playerId).limitToLast(6).get();
      recentLoot = []; lootSnap.forEach(s=>recentLoot.push(s.val()));
    }
    render();
  } catch(e){ console.error('ensureUserRTDB error', e); }
}

async function applyReferralRTDB(refId){
  try {
    const myRef = usersRef.child(playerId);
    const mySnap = await myRef.get();
    if (!mySnap.exists()) return;
    if (mySnap.val().referral_claimed) return;
    await myRef.update({ referral_claimed:true });
    balance += 50; await myRef.update({ balance });
    const refRef = usersRef.child(refId);
    const refSnap = await refRef.get();
    if (refSnap.exists()){
      const prev = Number(refSnap.val().balance || 0);
      await refRef.update({ balance: prev + 100 });
    }
    render();
  } catch(e){ console.warn('applyReferral error', e); }
}

ensureUserRTDB();

/* Persist periodically */
async function persist(force=false){
  if (tapBuffer >= 20 || force){
    tapBuffer = 0;
    try { await usersRef.child(playerId).update({ balance, score, totalTaps, booster: (booster.multiplier>1?booster:null) }); }
    catch(e){ console.warn('persist err', e); }
  }
}
setInterval(()=>persist(true), 15000);

/* Loot & booster */
async function grantLoot(amount, reason='event'){
  balance += amount;
  recentLoot.push({ amount, reason, ts: Date.now() });
  if (recentLoot.length > 12) recentLoot.shift();
  render();
  try {
    await lootRef.push({ playerId, amount, reason, ts: Date.now() });
    await usersRef.child(playerId).update({ balance });
  } catch(e){ console.warn('grantLoot error', e); }
}

async function giveBooster(mult, durSec){
  booster = { multiplier: mult, expiresAt: Date.now() + durSec*1000 };
  try { await usersRef.child(playerId).update({ booster }); } catch(e){ console.warn('booster write', e); }
  render();
  setTimeout(()=>{ if (Date.now() >= booster.expiresAt){ booster = { multiplier:1, expiresAt:0 }; render(); } }, durSec*1000 + 200);
}

/* Leaderboard */
const lbListEl = $id('lbList');
usersRef.orderByChild('balance').limitToLast(100).on('value', snap => {
  const arr = [];
  snap.forEach(s => arr.push(s.val()));
  arr.reverse();
  lbListEl.innerHTML = '';
  arr.forEach((u,i) => {
    const li = createNode('li');
    li.textContent = `${i+1}. ${u.username || u.playerId} â€” ${Number(u.balance || 0)} TOK`;
    lbListEl.appendChild(li);
  });
});

/* Ad integrations */
let adexiumWidget = null;
try {
  adexiumWidget = new AdexiumWidget({ wid: ADEXIUM_WID, adFormat: 'interstitial' });
  adexiumWidget.autoMode();
} catch(e){ console.warn('Adexium init error', e); }

function ensureMoneyTag(){ return typeof window[MONEYTAG_FUNC] === 'function' || !!document.querySelector(`script[data-sdk="${MONEYTAG_FUNC}"]`); }

async function showAdFlow(){
  try {
    if (adexiumWidget && typeof adexiumWidget.show === 'function') {
      try {
        const res = await adexiumWidget.show();
        if (res && res.rewarded) { await grantLoot(res.amount || 50, 'adexium_reward'); return 'rewarded'; }
        return 'requested';
      } catch(e){ console.warn('adexium.show error', e); }
    }
    if (ensureMoneyTag()){
      try {
        window[MONEYTAG_FUNC]();
        try { await fetch(VERIFY_AD_URL, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ playerId, source:'moneytag' }) }); } catch(e){}
        await grantLoot(10, 'ad_opt_reward');
        return 'requested';
      } catch(e){ console.warn('MoneyTag call failed', e); }
    }
  } catch(e){ console.warn('showAdFlow err', e); }
  const ok = confirm('Ad not available â€” simulate watch (OK = rewarded)?');
  if (ok){ await grantLoot(50, 'ad_sim'); return 'rewarded'; }
  return 'skipped';
}

/* Tap logic */
let sessionStart = 0, sessionTaps = 0;
$id('tapBtn').addEventListener('click', async () => {
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++; totalTaps++; tapBuffer++;
  const mult = (booster.multiplier>1 && booster.expiresAt > Date.now()) ? booster.multiplier : 1;
  const gain = Math.round(1 * mult + Math.random());
  score += gain;
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    recentLoot.push({ amount: tok, reason: 'tap_reward', ts: Date.now() });
    if (recentLoot.length > 12) recentLoot.shift();
  }
  render();
  pushLine(`> injected +${gain} pts`);
  if (Math.random() < 0.03) showGlitch(700);
  if (Math.random() < 0.02){ const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }

  if (totalTaps % 30 === 0){
    const durationMs = Date.now() - (sessionStart || Date.now());
    const sessionId = 'sess_' + (sessionStart || Date.now()) + '_' + Math.random().toString(36).slice(2,8);
    (async ()=>{
      try {
        await fetch(VERIFY_PLAY_URL, { method:'POST', headers:{'content-type':'application/json','x-admin-key':ADMIN_API_KEY}, body: JSON.stringify({ playerId, sessionId, taps: sessionTaps, durationMs, username: playerName }) });
      } catch(e){ console.warn('verifyPlay call failed', e); }
    })();
    sessionStart = 0; sessionTaps = 0;
    await onThirty();
  }

  if (tapBuffer >= 20) { await persist(); }
});

/* onThirty actions */
async function onThirty(){
  pushLine('!!! SYSTEM EVENT: 30 TAPS !!!');
  showGlitch(900);
  const res = await showAdFlow();
  if (res === 'requested' || res === 'rewarded'){
    await giveBooster(2, 20);
    const loot = Math.floor(Math.random()*150) + 50;
    await grantLoot(loot, '30tap_bonus');
    showModal('Reward', `Booster x2 (20s) +${loot} TOK (server verify pending).`);
  } else {
    const small = 20; await grantLoot(small, 'no_ad'); showModal('Notice', `Ad not available â€” you got ${small} TOK.`);
  }
}

/* Buttons */
$id('watchAdBtn').addEventListener('click', async ()=>{
  const r = await showAdFlow();
  if (r === 'requested' || r === 'rewarded') alert('Ad flow started / reward may be granted via server webhook.');
  else alert('Ad skipped or unavailable.');
});

$id('missionsBtn').addEventListener('click', ()=>{
  const m = showModal('Missions', `<ol><li>Tap 100 times â€” auto reward</li><li>Invite friend â€” reward on join</li><li>Watch ads â€” counted server-side</li></ol><div style="margin-top:10px"><button id="claimTest" class="small">Claim test +100 TOK (dev)</button></div>`);
  m.querySelector('#claimTest').onclick = async ()=>{ await grantLoot(100, 'mission_test'); m.remove(); };
});

$id('inviteBtn').addEventListener('click', ()=>{
  const link = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`;
  navigator.clipboard?.writeText(link).then(()=> showModal('Invite', `<p>Referral link copied:<br><strong>${link}</strong></p>`), ()=> showModal('Invite', `<p>Copy this link:<br><strong>${link}</strong></p>`));
});

/* cleanup */
window.addEventListener('beforeunload', ()=>persist(true));
render();
pushLine('Welcome â€” logged in with Telegram ID.');
</script>
</body>
</html>
