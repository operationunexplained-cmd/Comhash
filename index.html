<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper â€” ComHash (Adexium Only)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase Realtime Database (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<!-- Adexium Interstitial -->
<script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>

<style>
  /* Simple green theme (old UI) */
  :root{--bg:#f3fff6;--card:#ffffff;--accent:#0b8457;--muted:#4a6b59}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#0b2f1f}
  .wrap{width:420px;margin:18px auto;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(7,24,18,0.08)}
  h1{margin:0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .hud{display:flex;gap:8px;margin:12px 0}
  .stat{flex:1;background:#f6fff9;border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(11,132,87,0.06)}
  .big{font-weight:800;font-size:18px;color:var(--accent)}
  #hackArea{height:120px;background:#eaf8ef;border-radius:8px;padding:8px;font-family:monospace;overflow:auto;border:1px solid rgba(11,132,87,0.04)}
  .controls{display:flex;gap:8px;margin-top:12px}
  button{padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
  #tapBtn{background:var(--accent);color:#fff;font-weight:800;flex:1}
  .small{background:transparent;border:1px solid rgba(11,132,87,0.12);color:var(--accent);border-radius:8px;padding:8px}
  .footer{margin-top:12px;font-size:13px;color:var(--muted);text-align:center}
  .lb{max-height:280px;overflow:auto;margin-top:8px;padding:8px;background:#fbfffb;border-radius:8px;border:1px solid rgba(11,132,87,0.04)}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);z-index:10000;max-width:92%;width:360px}
  .closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
  .notice{background:#fff8ea;border:1px solid #ffe6b3;padding:8px;border-radius:8px;margin-top:12px;color:#6b4a00}
</style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>ðŸ’» Hacker Tapper</h1>
        <div class="muted">Inside Telegram â€” tap, watch, invite, win.</div>
      </div>
      <div id="playerTag" class="muted">Loading...</div>
    </div>

    <div class="hud" style="margin-top:12px">
      <div class="stat">Balance<div id="balance" class="big">0</div></div>
      <div class="stat">Score<div id="score" class="big">0</div></div>
      <div class="stat">Taps<div id="taps" class="big">0</div></div>
    </div>

    <div id="hackArea">Welcome â€” press TAP to start hacking.</div>

    <div class="controls" style="margin-top:12px">
      <button id="tapBtn">TAP TO INJECT</button>
      <button id="watchAdBtn" class="small">Watch Ad</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
      <button id="missionBtn" class="small">Claim Test Mission</button>
      <div style="margin-left:auto" class="muted">Referral: <span id="refLink">-</span></div>
    </div>

    <div style="margin-top:12px">
      <h3 style="margin:.2rem 0">Leaderboard (Top 100)</h3>
      <div id="leaderboard" class="lb"><ol id="lbList" style="margin:0;padding-left:16px"></ol></div>
    </div>

    <div class="footer">Host over HTTPS. Open via your Telegram bot (Web App).</div>
  </div>

  <div id="modalRoot"></div>

<script>
/* ================= CONFIG ================= */
/* Firebase config (your provided keys) */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.firebasestorage.app",
  messagingSenderId: "392187080052",
  appId: "1:39218708052:web:3e31391442ca1315dc1021",
  measurementId: "G-0YWTXYJ7RN"
};

/* Adexium WID (your provided) */
const ADEXIUM_WID = 'de78ddc3-cd12-4357-a6cf-8fe6c9155acc';

/* VERIFY endpoints (optional) */
const VERIFY_PLAY_URL = "https://comhashgame.vercel.app/verifyPlay";
const ADMIN_API_KEY = "COMHASH_ADMIN_2025";

/* Ad reward amount (real ad reward when provider confirms) */
const AD_REWARD_AMOUNT = 20; // TOK granted when ad is rewarded by provider
/* ========================================= */

function $id(id){ return document.getElementById(id); }
function createNode(t, a={}){ const e=document.createElement(t); Object.assign(e, a); return e; }

/* Initialize Firebase */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
const usersRef = db.ref('users');
const lootRef = db.ref('lootHistory');

/* Telegram WebApp (REQUIRED) */
const tg = window.Telegram?.WebApp || null;
try { tg?.expand?.(); } catch(e){}
const tgUser = tg?.initDataUnsafe?.user;
if (!tgUser || !tgUser.id){
  alert('Open this page inside Telegram (bot â†’ Web App). Telegram ID is required.');
  throw new Error('Telegram WebApp user required');
}
const playerId = String(tgUser.id);
const playerName = tgUser.first_name || tgUser.username || ('tg_' + playerId);
$id('playerTag').textContent = `${playerName} â€¢ ${playerId}`;

/* referral detection */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = (startParam && startParam.startsWith('ref_')) ? startParam.replace('ref_','') : null;

/* State (clean per Telegram user) */
let balance = 0, score = 0, totalTaps = 0, tapBuffer = 0;
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];

/* UI helpers */
function render(){
  $id('balance').textContent = balance;
  $id('score').textContent = score;
  $id('taps').textContent = totalTaps;
  $id('refLink').textContent = `https://t.me/comhash_bot?start=ref_${playerId}`;
}
function pushLine(text){ const el=createNode('div'); el.textContent=text; $id('hackArea').appendChild(el); while($id('hackArea').children.length>8) $id('hackArea').removeChild($id('hackArea').firstChild); }
function showModal(title, html){ const m=createNode('div'); m.className='modal'; m.innerHTML=`<div class="closeX">âœ•</div><h3>${title}</h3><div style="margin-top:8px">${html}</div>`; document.body.appendChild(m); m.querySelector('.closeX').onclick = ()=>m.remove(); return m; }
function showGlitch(ms=800){ const g=createNode('div'); g.className='notice'; g.textContent='SYSTEM GLITCH'; document.body.appendChild(g); setTimeout(()=>g.remove(), ms); }

/* Ensure user exists at users/<telegram_id> */
async function ensureUser(){
  try {
    const snap = await usersRef.child(playerId).get();
    if (!snap.exists()){
      await usersRef.child(playerId).set({
        playerId, username: playerName, balance:0, score:0, totalTaps:0, createdAt:Date.now(), referrer: referrerId || null
      });
      if (referrerId) await applyReferral(referrerId);
    } else {
      const d = snap.val();
      balance = Number(d.balance || 0);
      score = Number(d.score || 0);
      totalTaps = Number(d.totalTaps || 0);
      if (d.booster && d.booster.expiresAt && Date.now() < d.booster.expiresAt) booster = d.booster;
      // load recent loot (last 6)
      const lootSnap = await lootRef.orderByChild('playerId').equalTo(playerId).limitToLast(6).get();
      recentLoot = []; lootSnap.forEach(s => recentLoot.push(s.val()));
    }
    render();
  } catch(e){ console.error('ensureUser error', e); }
}
async function applyReferral(refId){
  try {
    const myRef = usersRef.child(playerId);
    const mySnap = await myRef.get();
    if (!mySnap.exists()) return;
    if (mySnap.val().referral_claimed) return;
    await myRef.update({ referral_claimed:true });
    balance += 50; await myRef.update({ balance });
    const rRef = usersRef.child(refId);
    const rSnap = await rRef.get();
    if (rSnap.exists()){
      const prev = Number(rSnap.val().balance || 0);
      await rRef.update({ balance: prev + 100 });
    }
    render();
  } catch(e){ console.warn('applyReferral error', e); }
}
ensureUser();

/* Persist periodically to DB */
async function persist(force=false){
  if (tapBuffer >= 20 || force){
    tapBuffer = 0;
    try { await usersRef.child(playerId).update({ balance, score, totalTaps, booster: (booster.multiplier>1?booster:null) }); }
    catch(e){ console.warn('persist err', e); }
  }
}
setInterval(()=>persist(true), 15000);

/* Loot & booster helpers */
async function grantLoot(amount, reason='event'){
  // client-first immediate UX update (DB authoritative)
  balance += amount;
  recentLoot.push({ amount, reason, ts: Date.now() });
  if (recentLoot.length > 12) recentLoot.shift();
  render();
  try {
    await lootRef.push({ playerId, amount, reason, ts: Date.now() });
    await usersRef.child(playerId).update({ balance });
  } catch(e){ console.warn('grantLoot err', e); }
}
async function giveBooster(mult, durSec){
  booster = { multiplier: mult, expiresAt: Date.now() + durSec*1000 };
  try { await usersRef.child(playerId).update({ booster }); } catch(e){ console.warn('booster err', e); }
  render();
  setTimeout(()=>{ if (Date.now() >= booster.expiresAt){ booster = { multiplier:1, expiresAt:0 }; render(); } }, durSec*1000 + 200);
}

/* Leaderboard top 100 realtime */
usersRef.orderByChild('balance').limitToLast(100).on('value', snap=>{
  const arr=[]; snap.forEach(s=>arr.push(s.val())); arr.reverse();
  const ol = $id('lbList'); if (!ol) return;
  ol.innerHTML = '';
  arr.forEach((u,i)=>{ const li = createNode('li'); li.textContent = `${i+1}. ${u.username || u.playerId} â€” ${Number(u.balance||0)} TOK`; ol.appendChild(li); });
});

/* Initialize Adexium widget (using your WID) */
let adexiumWidget = null;
try {
  adexiumWidget = new AdexiumWidget({ wid: ADEXIUM_WID, adFormat: 'interstitial' });
  // Depending on Adexium version, autoMode will preload/auto-show when ready.
  // We'll call show() explicitly when needed.
  // We still call autoMode to help preload.
  if (typeof adexiumWidget.autoMode === 'function') adexiumWidget.autoMode();
} catch(e){ console.warn('Adexium init error', e); }

/* showAdFlow - ADExium only â€” no simulated reward path */
async function showAdFlow(){
  if (!adexiumWidget || typeof adexiumWidget.show !== 'function'){
    // Adexium not available or script failed to load.
    // Do NOT simulate reward; inform user to try later.
    alert('Ad service unavailable â€” try again later.');
    return 'unavailable';
  }

  try {
    // Many Adexium SDKs either return a Promise or use events.
    // We'll first try awaiting a promise result from show()
    const res = await adexiumWidget.show();
    // If provider returns structured result with rewarded flag:
    if (res && (res.rewarded === true || res.rewarded === 'true')) {
      // Provider signalled reward immediately
      await grantLoot(AD_REWARD_AMOUNT, 'adexium_reward');
      return 'rewarded';
    }
    // If provider returns an object without 'rewarded',
    // it may still call a webhook or event â€” treat as requested.
    // Do not grant client-side reward unless SDK confirms.
    // Optionally call server to verify later via webhook.
    return 'requested';
  } catch(err){
    // If show() throws, ad failed to play or not ready
    console.warn('adexium.show failed', err);
    alert('Ad failed to play â€” try again later.');
    return 'failed';
  }
}

/* Tap logic */
let sessionStart = 0, sessionTaps = 0;
$id('tapBtn').addEventListener('click', async ()=>{
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++; totalTaps++; tapBuffer++;
  const mult = (booster.multiplier>1 && booster.expiresAt > Date.now()) ? booster.multiplier : 1;
  const gain = Math.round(1 * mult + Math.random());
  score += gain;

  // reward TOK every 5 taps locally
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    recentLoot.push({ amount: tok, reason: 'tap_reward', ts: Date.now() });
    if (recentLoot.length > 12) recentLoot.shift();
  }
  render();
  pushLine(`> injected +${gain} pts`);
  if (Math.random() < 0.03) showGlitch(700);
  if (Math.random() < 0.02){ const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }

  // every 30 taps: trigger ad (Adexium) AND server verify call
  if (totalTaps % 30 === 0){
    const durationMs = Date.now() - (sessionStart || Date.now());
    const sessionId = 'sess_' + (sessionStart || Date.now()) + '_' + Math.random().toString(36).slice(2,8);
    // call verifyPlay endpoint if you have server-side anti-cheat (optional)
    (async ()=>{
      try {
        await fetch(VERIFY_PLAY_URL, { method:'POST', headers:{'content-type':'application/json','x-admin-key':ADMIN_API_KEY}, body: JSON.stringify({ playerId, sessionId, taps: sessionTaps, durationMs, username: playerName }) });
      } catch(e){ console.warn('verifyPlay call failed', e); }
    })();
    sessionStart = 0; sessionTaps = 0;

    // Trigger ad flow (Adexium) â€” real ad, no simulation
    const adRes = await showAdFlow();
    if (adRes === 'rewarded'){
      // provider confirmed reward via show() result
      await giveBooster(2, 20);
      const loot = Math.floor(Math.random()*150) + 50;
      await grantLoot(loot, '30tap_ad_reward');
      showModal('Reward', `Ad confirmed reward. Booster x2 (20s) +${loot} TOK.`);
    } else if (adRes === 'requested'){
      // Ad played; reward will be authoritative if provider webhook hits your server.
      showModal('Ad started', 'Ad started. Reward will be granted when the ad provider confirms via webhook.');
    } else {
      // failed/unavailable â€” no simulated reward
      showModal('Ad unavailable', 'Ad could not be played. No reward was given.');
    }
  }

  if (tapBuffer >= 20) { await persist(); }
});

/* onThirty fallback when manually triggered (not used since ad is automatic above) */
async function onThirty(){ /* reserved if needed */ }

/* Buttons: Watch Ad, Mission, Invite */
$id('watchAdBtn').addEventListener('click', async ()=>{
  const r = await showAdFlow();
  if (r === 'rewarded') {
    // provider confirmed reward immediately
    alert(`Ad rewarded: +${AD_REWARD_AMOUNT} TOK.`);
  } else if (r === 'requested') {
    alert('Ad started â€” reward pending provider confirmation.');
  } else {
    // 'failed' or 'unavailable'
  }
});

$id('missionBtn').addEventListener('click', ()=>{
  const m = showModal('Mission', `<p>Test mission: claim +100 TOK (dev)</p><div style="margin-top:10px"><button id="claimTest" class="small">Claim +100</button></div>`);
  m.querySelector('#claimTest').onclick = async ()=>{
    await grantLoot(100, 'mission_test');
    m.remove();
  };
});

/* Invite: copy referral link */
$id('refLink').textContent = `https://t.me/comhash_bot?start=ref_${playerId}`;

/* cleanup */
window.addEventListener('beforeunload', ()=>persist(true));
render();
pushLine('Welcome â€” logged in with Telegram ID. Adexium enabled (no simulation).');
</script>
</body>
</html>
