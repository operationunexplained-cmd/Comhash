<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper — ComHash (Premium)</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase Realtime Database (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<!-- MoneyTag SDK -->
<script src="//libtl.com/sdk.js" data-zone="10199103" data-sdk="show_10199103"></script>

<style>
:root{
  --bg1:#020610;
  --bg2:#02121a;
  --card:#071425;
  --neon:#00ff88;
  --muted:#8fb6c6;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e8fff6}
.container{max-width:980px;margin:18px auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,#006bff,#00ff88);display:flex;align-items:center;justify-content:center;font-weight:800;color:#021}
.title{font-size:20px;margin:0}
.subtitle{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:12px;border:1px solid var(--glass)}
.hud{display:flex;gap:10px;justify-content:space-between;margin-bottom:12px}
.stat{flex:1;padding:10px;border-radius:8px;background:rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.03)}
.stat .big{font-size:18px;font-weight:800;color:var(--neon)}
.controls{display:flex;gap:8px;align-items:center}
.button{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--neon),#77ffd0);color:#012;font-weight:700;cursor:pointer}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
.small{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--neon);cursor:pointer}
.hackArea{height:150px;background:#00121a;border-radius:8px;padding:10px;color:#7ef2d7;overflow:auto;font-family:monospace}
.list{max-height:360px;overflow:auto}
.leaderboard ol{padding-left:14px;margin:0}
.muted{color:var(--muted);font-size:13px}
.modal-back{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
.modal{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:10px;border:1px solid var(--glass);min-width:320px}
.footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.18);color:var(--muted);font-weight:700}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">C</div>
        <div>
          <h1 class="title">Hacker Tapper — ComHash</h1>
          <div class="subtitle">Tap. Watch. Claim missions. Earn TOK — inside Telegram</div>
        </div>
      </div>
      <div class="controls">
        <div id="playerTag" class="muted">Loading...</div>
        <button id="profileBtn" class="button ghost">Profile</button>
      </div>
    </header>

    <div class="grid">
      <main>
        <div class="card">
          <div class="hud">
            <div class="stat"><div class="muted">Balance</div><div class="big" id="balance">0</div></div>
            <div class="stat"><div class="muted">Score</div><div class="big" id="score">0</div></div>
            <div class="stat"><div class="muted">Taps</div><div class="big" id="taps">0</div></div>
          </div>

          <div class="hackArea" id="hackAnim" aria-live="polite"></div>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button id="tapBtn" class="button" style="flex:1">TAP TO INJECT</button>
            <button id="watchAdBtn" class="small">Watch Ad</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <button id="missionsBtn" class="small">Missions</button>
            <button id="inviteBtn" class="small">Invite</button>
            <div style="margin-left:auto" class="muted">Referral: <span id="refLink">-</span></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin:0">Missions</h3>
          <div id="missionsList" class="list muted" style="margin-top:8px">Loading missions…</div>
        </div>
      </main>

      <aside>
        <div class="card leaderboard">
          <h3 style="margin:0">Leaderboard <span class="badge">Top 100</span></h3>
          <div style="margin-top:8px" id="leaderboardWrap"><ol id="lbList"></ol></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4 style="margin:0">Recent Loot</h4>
          <div id="lootList" class="muted list" style="margin-top:8px">-</div>
        </div>
      </aside>
    </div>

    <div class="footer">ComHash • Neon UI — Open inside Telegram WebApp for full features</div>
  </div>

  <!-- modal -->
  <div id="modalBack" class="modal-back"><div id="modal" class="modal"></div></div>

<script>
/* ================= CONFIG ================= */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.firebasestorage.app",
  messagingSenderId: "392187080052",
  appId: "1:392187080052:web:3e31391442ca1315dc1021"
};
const MONEYTAG_FUNC = 'show_10199103'; // function exposed by MoneyTag SDK
const MISSION_CLAIM_COOLDOWN_MS = 1000 * 2; // safety between claims
/* ========================================== */

/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
const create = (t, a={}) => { const el = document.createElement(t); Object.assign(el, a); return el; };
function modalShow(title, innerHtml){
  $('modal').innerHTML = `<h3 style="margin:0">${title}</h3><div style="margin-top:8px">${innerHtml}</div>`;
  $('modalBack').style.display = 'flex';
}
function modalHide(){ $('modalBack').style.display = 'none'; }

/* ---------- firebase init ---------- */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();
const usersRef = rdb.ref('users');
const lootRef = rdb.ref('lootHistory');
const missionsRef = rdb.ref('missions');

/* ---------- Telegram identity (strict A) ---------- */
const tg = window.Telegram?.WebApp || null;
try { tg?.expand?.(); } catch(e){}
const tgInit = tg?.initDataUnsafe || null;
const tgUser = tgInit?.user || null;
if (!tgUser || !tgUser.id){
  // required in strict mode
  document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:#fff;background:#071021">
    <div style="max-width:720px;padding:20px;text-align:center">
      <h2>Open inside Telegram</h2>
      <p class="muted">This game requires Telegram login (strict mode). Open the bot and tap the Web App button.</p>
    </div></div>`;
  throw new Error('Telegram user required');
}
const playerId = 'tg_' + String(tgUser.id);
const playerName = tgUser.first_name || playerId;
$('playerTag').textContent = `${playerName} • ${playerId}`;

/* ---------- local identity safety ---------- */
(function ensureLocalIdentity(){
  const stored = localStorage.getItem('ht_player_id');
  if (stored !== playerId){
    // new player on this device — wipe ephemeral caches
    localStorage.removeItem('ht_balance');
    localStorage.removeItem('ht_score');
    localStorage.removeItem('ht_totalTaps');
    localStorage.setItem('ht_player_id', playerId);
  }
})();

/* ---------- state ---------- */
let balance = Number(localStorage.getItem('ht_balance') || 0);
let score = Number(localStorage.getItem('ht_score') || 0);
let totalTaps = Number(localStorage.getItem('ht_totalTaps') || 0);
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];
let lastMissionClaimMs = 0;

/* ---------- UI render ---------- */
function render(){
  $('balance').textContent = balance;
  $('score').textContent = score;
  $('taps').textContent = totalTaps;
  $('refLink').textContent = `https://t.me/comhash_bot?start=ref_${playerId}`;
  $('lootList').innerHTML = recentLoot.slice(0,12).map(l=>`<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('') || '-';
  $('boosterInfo')?.textContent = (booster.multiplier>1 && Date.now()<booster.expiresAt)?`x${booster.multiplier} (exp ${new Date(booster.expiresAt).toLocaleTimeString()})`:'None';
}

/* ---------- ensure user exists & sync ---------- */
async function ensureUserAndSync(){
  const snap = await usersRef.child(playerId).get();
  if (!snap.exists()){
    await usersRef.child(playerId).set({
      playerId, username: playerName, balance:0, score:0, totalTaps:0, createdAt: Date.now(),
      referrer: (tgInit?.start_param && tgInit.start_param.startsWith('ref_')) ? tgInit.start_param.replace('ref_','') : null
    });
  } else {
    const d = snap.val();
    balance = Number(d.balance||0); score = Number(d.score||0); totalTaps = Number(d.totalTaps||0);
    if (d.booster && d.booster.expiresAt && Date.now()<d.booster.expiresAt) booster = d.booster;
  }
  render();
  // subscribe to authoritative user node
  usersRef.child(playerId).on('value', s=>{
    const d = s.val()||{};
    balance = Number(d.balance||0); score = Number(d.score||0); totalTaps = Number(d.totalTaps||0);
    if (d.booster && d.booster.expiresAt && Date.now()<d.booster.expiresAt) booster = d.booster;
    render();
    // cache locally
    localStorage.setItem('ht_balance', String(balance));
    localStorage.setItem('ht_score', String(score));
    localStorage.setItem('ht_totalTaps', String(totalTaps));
  });
  // subscribe to user's loot
  lootRef.orderByChild('playerId').equalTo(playerId).limitToLast(20).on('value', snap=>{
    const arr=[]; snap.forEach(s=>arr.push(s.val())); arr.sort((a,b)=>b.ts-a.ts); recentLoot = arr; render();
  });
}
ensureUserAndSync();

/* ---------- leaderboard top 100 ---------- */
usersRef.orderByChild('balance').limitToLast(100).on('value', snap=>{
  const arr=[]; snap.forEach(s=>arr.push(s.val())); arr.sort((a,b)=>Number(b.balance||0)-Number(a.balance||0));
  $('lbList').innerHTML = '';
  arr.forEach((u,i)=>{
    const li = create('li'); li.textContent = `${i+1}. ${u.username||u.playerId} — ${Number(u.balance||0)} TOK`;
    $('lbList').appendChild(li);
  });
});

/* ---------- missions list (db-driven) ---------- */
missionsRef.on('value', snap=>{
  const data = snap.val() || {};
  const html = Object.values(data).map(m=>{
    return `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px">
      <div style="display:flex;justify-content:space-between"><div><strong>${m.title}</strong><div class="muted" style="font-size:13px">${m.desc||''}</div></div><div>${m.reward||0} TOK</div></div>
      <div style="margin-top:8px"><button class="small" onclick="claimMission('${m.id}')">Claim</button></div>
    </div>`;
  }).join('') || '<div class="muted">No missions available</div>';
  $('missionsList').innerHTML = html;
});

/* ---------- mission claim logic ---------- */
async function claimMission(missionId){
  // throttle accidental double clicks
  if (Date.now() - lastMissionClaimMs < MISSION_CLAIM_COOLDOWN_MS){ alert('Please wait'); return; }
  lastMissionClaimMs = Date.now();

  // check mission existence
  const mSnap = await missionsRef.child(missionId).get();
  if (!mSnap.exists()){ alert('Mission missing'); return; }
  const mission = mSnap.val();

  // check user's missions map to avoid double claim
  const userSnap = await usersRef.child(playerId).get();
  const userData = userSnap.val() || {};
  const claimed = (userData.missions && userData.missions[missionId] && userData.missions[missionId].claimed);
  if (claimed){ alert('Already claimed'); return; }

  // apply reward atomically (transaction on user node)
  await usersRef.child(playerId).transaction(curr=>{
    curr = curr || {};
    curr.balance = Number(curr.balance || 0) + Number(mission.reward || 0);
    curr.missions = curr.missions || {};
    curr.missions[missionId] = { claimed: true, ts: Date.now(), reward: mission.reward || 0 };
    return curr;
  });
  await lootRef.push({ playerId, amount: mission.reward || 0, reason: 'mission_claim:'+missionId, ts: Date.now() });
  showModal('Mission Claimed', `You received ${mission.reward || 0} TOK`);
}

/* ---------- grant loot helper (used by ad callback) ---------- */
async function grantLoot(amount, reason='ad_reward'){
  // optimistic UI
  balance += amount; render();
  // write loot & update server balance atomically
  await lootRef.push({ playerId, amount, reason, ts: Date.now() });
  await usersRef.child(playerId).transaction(curr=>{
    curr = curr || {};
    curr.balance = Number(curr.balance || 0) + Number(amount || 0);
    return curr;
  });
}

/* ---------- MoneyTag ad flow ---------- */
function ensureMoneyTag(){
  if (typeof window[MONEYTAG_FUNC] === 'function') return true;
  // attempt to ensure SDK loaded (script tag likely already there)
  const s = document.querySelector('script[data-sdk="show_10199103"]');
  if (!s){
    const sc = create('script'); sc.src='//libtl.com/sdk.js'; sc.dataset.zone='10199103'; sc.dataset.sdk='show_10199103';
    document.head.appendChild(sc);
  }
  return !!window[MONEYTAG_FUNC];
}

async function showAd(){
  if (!ensureMoneyTag()){ alert('Ad SDK not loaded. Try inside Telegram app.'); return; }
  const fn = window[MONEYTAG_FUNC];
  if (typeof fn !== 'function'){ alert('Ad function missing'); return; }

  try {
    let rewarded = false;
    // try calling with callbacks (supported by many MoneyTag SDKs)
    fn({
      onReward: async ()=>{ rewarded = true; await grantLoot(50,'ad_reward'); showModal('Ad Reward','+50 TOK'); },
      onClose: ()=>{ if (!rewarded) showModal('Ad', 'Ad closed — no reward'); },
      onError: (err)=>{ console.warn('MoneyTag err',err); showModal('Ad Error','Ad failed to play'); }
    });
    return 'requested';
  } catch(e){
    // fallback: call directly and ask confirmation (testing only)
    try { fn(); } catch(ex){ console.warn('call fail',ex); }
    const ok = confirm('Mark ad watched? (testing fallback)');
    if (ok){ await grantLoot(50,'ad_reward_fallback'); showModal('Ad Reward','+50 TOK'); return 'rewarded'; }
    return 'skipped';
  }
}

/* ---------- tap logic ---------- */
let sessionStart = 0, sessionTaps = 0, tapBuffer = 0;
$('tapBtn').addEventListener('click', async ()=>{
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++; totalTaps++; tapBuffer++;
  const mult = (booster.multiplier>1 && booster.expiresAt > Date.now())?booster.multiplier:1;
  const gain = Math.round(1 * mult + Math.random());
  score += gain;
  // every 5 taps give small TOK
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    recentLoot.unshift({ amount: tok, reason:'tap_reward', ts: Date.now() });
    if (recentLoot.length>20) recentLoot.pop();
  }
  render();
  pushLine(`> injected +${gain} pts`);
  if (Math.random() < 0.03) showGlitch(700);
  if (Math.random() < 0.02){ const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }
  if (totalTaps % 30 === 0){
    await onThirty();
    sessionStart = 0; sessionTaps = 0;
  }
  // buffer writes
  if (tapBuffer >= 10){
    tapBuffer = 0;
    await usersRef.child(playerId).update({ balance, score, totalTaps, updatedAt: Date.now() });
  }
});

/* ---------- onThirty ---------- */
async function onThirty(){
  pushLine('!!! 30 TAPS EVENT !!!');
  showGlitch(800);
  const adRes = await showAd();
  if (adRes === 'rewarded' || adRes==='requested'){
    await giveBooster(2, 25);
    const loot = Math.floor(Math.random()*150)+50;
    await grantLoot(loot,'30tap_bonus');
    showModal('30-tap Reward', `Booster x2 (25s) +${loot} TOK`);
  } else {
    await grantLoot(20,'30tap_noad');
    showModal('Notice','No ad — +20 TOK');
  }
}

/* ---------- giveBooster ---------- */
async function giveBooster(mult, durSeconds){
  booster = { multiplier:mult, expiresAt: Date.now() + durSeconds*1000 };
  await usersRef.child(playerId).update({ booster });
  render();
  setTimeout(()=>{ if (Date.now()>=booster.expiresAt){ booster={multiplier:1,expiresAt:0}; render(); } }, durSeconds*1000 + 300);
}

/* ---------- watch ad button ---------- */
$('watchAdBtn').addEventListener('click', async ()=> { await showAd(); });

/* ---------- missions button (open profile-based modal) ---------- */
$('missionsBtn').addEventListener('click', ()=> {
  // Show missions modal (simple view)
  modalShow('Missions', `<div id="modalMissions" style="max-height:300px;overflow:auto"></div><div style="margin-top:10px"><button class="small" onclick="modalHide()">Close</button></div>`);
  // load missions view into modal
  missionsRef.once('value').then(snap=>{
    const data = snap.val() || {};
    const html = Object.values(data).map(m=>{
      return `<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px">
        <div style="display:flex;justify-content:space-between"><div><strong>${m.title}</strong><div class="muted">${m.desc||''}</div></div><div>${m.reward||0} TOK</div></div>
        <div style="margin-top:8px"><button class="small" onclick="claimMission('${m.id}')">Claim</button></div>
      </div>`;
    }).join('') || '<div class="muted">No missions</div>';
    $('modalMissions').innerHTML = html;
  });
});

/* ---------- profile modal ---------- */
$('profileBtn').addEventListener('click', ()=> {
  modalShow('Profile', `<div><strong>${playerName}</strong><div class="muted">ID: ${playerId}</div></div><div style="margin-top:10px">Balance: <b id="pmBal">${balance}</b><br>Score: <b id="pmScore">${score}</b><br>Taps: <b id="pmTaps">${totalTaps}</b></div><div style="margin-top:12px"><button class="small" onclick="modalHide()">Close</button></div>`);
});

/* update profile modal numbers when UI updates */
const origRender = render;
render = function(){ origRender(); const m = document.getElementById('pmBal'); if (m) m.textContent = balance; const m2 = document.getElementById('pmScore'); if (m2) m2.textContent = score; const m3 = document.getElementById('pmTaps'); if (m3) m3.textContent = totalTaps; };

/* ---------- invite ---------- */
$('inviteBtn').addEventListener('click', ()=> {
  const link = `https://t.me/comhash_bot?start=ref_${playerId}`;
  navigator.clipboard?.writeText(link).then(()=> alert('Referral copied'), ()=> alert(link));
});

/* ---------- persist on unload ---------- */
window.addEventListener('beforeunload', ()=> {
  usersRef.child(playerId).update({ balance, score, totalTaps, updatedAt: Date.now(), booster:(booster.multiplier>1?booster:null) });
});

/* ---------- utility to show glitch ---------- */
function showGlitch(ms=700){ const g = document.getElementById('glitch'); g.style.display='block'; setTimeout(()=>g.style.display='none', ms); }

/* ---------- initial render ---------- */
render();

</script>
</body>
</html>
