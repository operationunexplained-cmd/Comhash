<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper â€” Telegram Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

<!-- MoneyTag SDK -->
<script src="https://libtl.com/sdk.js" data-zone="10199103" data-sdk="show_10199103"></script>

<style>
:root{--bg:#020610;--card:#071425;--accent:#00e5a8;--muted:#93b6c6}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#001018,#020610);color:#d8f6f0}
.wrap{max-width:720px;margin:12px auto;padding:14px}
header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;font-size:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
#game{display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px}
#left{padding:12px}
#right{padding:12px}
.hud{display:flex;gap:10px;justify-content:space-between;margin-bottom:10px}
.stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-width:0}
#tapBtn{width:100%;padding:16px;border-radius:12px;background:linear-gradient(180deg,#023c32,#01513f);border:0;color:#fff;font-weight:800;font-size:18px}
.small{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
#hackAnim{height:130px;background:#00121a;border-radius:8px;padding:10px;color:#7ef2d7;overflow:hidden;font-family:monospace}
.line{opacity:0;transform:translateY(6px);animation:in .45s forwards}
@keyframes in{to{opacity:1;transform:none}}
#glitch{position:fixed;inset:0;display:none;z-index:9999;pointer-events:none}
.glitchLayer{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,0,120,0.06), rgba(0,255,200,0.06));mix-blend-mode:screen;filter:contrast(1.2) saturate(1.2);animation:glitchAnim .8s ease-in-out}
@keyframes glitchAnim{0%{transform:translateX(0)}50%{transform:translateX(6px) skewX(-2deg)}100%{transform:translateX(0)}}
ol{padding-left:18px;margin:8px 0}
.muted{color:var(--muted);font-size:13px}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071021;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);z-index:10000;max-width:92%;width:420px}
.closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
@media (max-width:480px){#game{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="wrap card">
  <header>
    <div>
      <h1>ðŸ’» Hacker Tapper</h1>
      <div class="muted">Inside Telegram â€” tap, watch, invite, win.</div>
    </div>
    <div id="playerTag" class="muted">Loading...</div>
  </header>

  <div id="game" class="card">
    <div id="left">
      <div class="hud">
        <div class="stat">Balance: <strong id="balance">0</strong> TOK</div>
        <div class="stat">Score: <strong id="score">0</strong></div>
        <div class="stat">Taps: <strong id="taps">0</strong></div>
      </div>

      <div id="hackAnim" aria-hidden="false"></div>

      <button id="tapBtn">TAP TO INJECT</button>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="small" id="watchAdBtn">Watch Ad (reward)</button>
        <button class="small" id="missionsBtn">Missions</button>
        <button class="small" id="inviteBtn">Invite</button>
      </div>

      <div id="refBox" class="muted" style="margin-top:12px">Referral: <span id="refLink">-</span></div>
    </div>

    <aside id="right">
      <div>
        <h3 style="margin:0">Leaderboard (Top 100)</h3>
        <div id="leaderboard" style="margin-top:8px">
          <ol id="lbList"></ol>
        </div>

        <div style="margin-top:12px"><strong>Booster:</strong> <span id="boosterInfo">None</span></div>

        <div style="margin-top:12px"><strong>Recent Loot:</strong>
          <div id="lootList" class="muted" style="max-height:120px;overflow:auto"></div>
        </div>
      </div>
    </aside>
  </div>
  <div class="muted" style="margin-top:12px">Host over HTTPS. Replace config & server URLs before production.</div>
</div>

<div id="glitch"><div class="glitchLayer"></div></div>
<div id="modalRoot"></div>

<script>
/* ---------- CONFIG ---------- */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.appspot.com",
  messagingSenderId: "392187080052",
  appId: "1:392187080052:web:3e31391442ca1315dc1021",
  measurementId: "G-0YWTXYJ7RN"
};
const BOT_USERNAME = 'comhash_bot';

/* ---------- HELPERS ---------- */
function $id(id){ return document.getElementById(id); }
function createNode(tag, attrs = {}){ const el = document.createElement(tag); Object.assign(el, attrs); return el; }
function showModal(title, bodyHtml){
  const m = createNode('div'); m.className='modal';
  m.innerHTML = `<div class="closeX">âœ•</div><h3>${title}</h3><div style="margin-top:8px">${bodyHtml}</div>`;
  document.getElementById('modalRoot').appendChild(m);
  m.querySelector('.closeX').onclick = ()=>m.remove();
  return m;
}

/* ---------- INIT FIREBASE ---------- */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const usersColl = db.collection('users');

/* ---------- TELEGRAM ---------- */
const tg = window.Telegram?.WebApp || null;
if (tg) try { tg.expand(); } catch(e){}

const tgUser = tg?.initDataUnsafe?.user || {};
const playerId = String(tgUser?.id || ('guest_' + Math.random().toString(36).slice(2,9)));
const playerName = tgUser?.first_name || 'Guest';
$id('playerTag').textContent = `${playerName} â€¢ ${playerId}`;

/* referral */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = null;
if (startParam && startParam.startsWith('ref_')) referrerId = startParam.replace('ref_','');

/* ---------- STATE ---------- */
let balance = Number(localStorage.getItem('ht_balance') || 0);
let score = Number(localStorage.getItem('ht_score') || 0);
let totalTaps = Number(localStorage.getItem('ht_totalTaps') || 0);
let tapBuffer = 0;
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];

/* ---------- UI ---------- */
function render(){
  $id('balance').textContent = balance;
  $id('score').textContent = score;
  $id('taps').textContent = totalTaps;
  $id('boosterInfo').textContent = (booster.multiplier>1 && Date.now() < booster.expiresAt) ? `x${booster.multiplier} (exp ${new Date(booster.expiresAt).toLocaleTimeString()})` : 'None';
  $id('refLink').textContent = `https://t.me/${BOT_USERNAME}?start=ref_${playerId}`;
  $id('lootList').innerHTML = recentLoot.slice().reverse().map(l=>`<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('');
}
render();

/* ---------- USER DOC ---------- */
async function ensureUser(){
  const docRef = usersColl.doc(playerId);
  const snap = await docRef.get();
  if (!snap.exists){
    await docRef.set({
      playerId, username: playerName, balance, score, totalTaps,
      booster: null, referrer: referrerId || null, referral_claimed:false, createdAt: Date.now()
    });
    if (referrerId) await applyReferral(referrerId);
  } else {
    const data = snap.data();
    balance = Number(data.balance || balance);
    score = Number(data.score || score);
    totalTaps = Number(data.totalTaps || totalTaps);
  }
  render();
}
ensureUser();

/* ---------- REFERRAL ---------- */
async function applyReferral(refId){
  const uRef = usersColl.doc(playerId);
  const snap = await uRef.get();
  if (!snap.exists) return;
  const data = snap.data();
  if (data.referral_claimed) return;
  await uRef.update({ referral_claimed:true });
  const newUserReward = 50;
  balance += newUserReward;
  await uRef.update({ balance });
  const refRef = usersColl.doc(refId);
  const refSnap = await refRef.get();
  if (refSnap.exists){
    const prev = Number(refSnap.data().balance || 0);
    const refReward = 100;
    await refRef.update({ balance: prev + refReward });
  }
  render();
}

/* ---------- PERSIST ---------- */
async function persist(force=false){
  localStorage.setItem('ht_balance', String(balance));
  localStorage.setItem('ht_score', String(score));
  localStorage.setItem('ht_totalTaps', String(totalTaps));
  if (tapBuffer>=20 || force){
    tapBuffer=0;
    try{
      await usersColl.doc(playerId).set({ balance, score, totalTaps, booster:(booster.multiplier>1?booster:null) }, { merge:true });
    } catch(e){ console.warn(e); }
  }
}
setInterval(()=>persist(true),15000);

/* ---------- HACK ANIMATION ---------- */
const hackAnimEl = $id('hackAnim');
function pushLine(text){
  const el = document.createElement('div');
  el.className='line';
  el.textContent=text;
  hackAnimEl.appendChild(el);
  while(hackAnimEl.children.length>6) hackAnimEl.removeChild(hackAnimEl.firstChild);
}
function showGlitch(ms=800){ const g=$id('glitch'); g.style.display='block'; setTimeout(()=>g.style.display='none',ms); }

/* ---------- LOOT ---------- */
async function grantLoot(amount,reason='event'){
  balance+=amount;
  recentLoot.push({amount,reason,ts:Date.now()});
  if (recentLoot.length>12) recentLoot.shift();
  render();
  try { await usersColl.doc(playerId).set({balance},{merge:true}); } catch(e){ console.warn(e); }
}

/* ---------- BOOSTER ---------- */
async function giveBooster(mult,dur){
  booster={multiplier:mult,expiresAt:Date.now()+dur*1000};
  try{ await usersColl.doc(playerId).set({booster},{merge:true}); } catch(e){ console.warn(e); }
  render();
  setTimeout(()=>{ if(Date.now()>=booster.expiresAt){ booster={multiplier:1,expiresAt:0}; render(); } },dur*1000+200);
}

/* ---------- LEADERBOARD ---------- */
async function refreshLeaderboard(){
  try{
    const snaps=await usersColl.orderBy('balance','desc').limit(100).get();
    $id('lbList').innerHTML='';
    snaps.forEach(d=>{
      const dd=d.data();
      const li=document.createElement('li');
      li.textContent=`${dd.username||dd.playerId} â€” ${dd.balance}`;
      $id('lbList').appendChild(li);
    });
  } catch(e){ console.warn('lb error',e); }
}
refreshLeaderboard();
setInterval(refreshLeaderboard,15000);

/* ---------- TAP LOGIC ---------- */
let sessionStart=0,sessionTaps=0;
$id('tapBtn').addEventListener('click',async()=>{
  if(!sessionStart) sessionStart=Date.now();
  sessionTaps++; totalTaps++; tapBuffer++;
  const mult=(booster.multiplier>1&&booster.expiresAt>Date.now())?booster.multiplier:1;
  const gain=Math.round(1*mult+Math.random()*1);
  score+=gain;
  if(totalTaps%5===0){ const tok=Math.max(1,Math.floor(gain/1)); balance+=tok; recentLoot.push({amount:tok,reason:'tap_reward',ts:Date.now()}); if(recentLoot.length>12) recentLoot.shift(); }
  render();
  pushLine(`> injected +${gain} pts`);
  if(Math.random()<0.03) showGlitch(700);
  if(Math.random()<0.02){ const amt=Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }
  if(totalTaps%30===0){ await onThirty(); sessionStart=0; sessionTaps=0; }
  if(tapBuffer>=20) await persist();
});

/* ---------- 30-TAP EVENT ---------- */
async function onThirty(){
  pushLine('!!! SYSTEM EVENT: 30 TAPS !!!');
  showGlitch(900);
  const result = await showAdFlow();
  if(result==='rewarded'){ await giveBooster(2,20); const loot=Math.floor(Math.random()*150)+50; await grantLoot(loot,'ad_loot'); showModal('Reward',`Ad watched â€” Booster x2 +${loot} TOK!`);}
  else{ const small=20; await grantLoot(small,'no_ad'); showModal('Notice',`Ad not available â€” you got ${small} TOK.`);}
}

/* ---------- MISSIONS ---------- */
function showMission(id,text){
  const m=createNode('div'); m.className='modal';
  m.innerHTML=`<div class="closeX">âœ•</div><h3>Mission</h3><div style="margin-top:8px">${text}</div>
  <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
    <div class="muted">Reward: 100 TOK</div>
    <button id="claimBtn" class="small">Claim</button>
  </div>`;
  document.getElementById('modalRoot').appendChild(m);
  m.querySelector('.closeX').onclick=()=>m.remove();
  m.querySelector('#claimBtn').onclick=async()=>{
    await grantLoot(100,'mission_claim'); m.remove();
  };
}

/* ---------- MONEYTAG AD FLOW ---------- */
async function showAdFlow(){
  try{
    if(typeof window.show_10199103==='function'){
      window.show_10199103();
      return 'rewarded';
    }
  } catch(e){ console.warn('MoneyTag ad error',e); }
  return 'skipped';
}

/* ---------- BUTTON EVENTS ---------- */
$id('watchAdBtn').addEventListener('click',async()=>{ const r=await showAdFlow(); if(r==='rewarded'){ await grantLoot(50,'manual_ad'); alert('Ad rewarded 50 TOK'); } else alert('Ad skipped/unavailable'); });
$id('missionsBtn').addEventListener('click',()=>showMission('manual1','Manual mission: claim 25 TOK'));
$id('inviteBtn').addEventListener('click',()=>{ const link=`https://t.me/${BOT_USERNAME}?start=ref_${playerId}`; navigator.clipboard?.writeText(link).then(()=>alert('Referral link copied'),()=>alert(link)); });

/* ---------- PERSIST ---------- */
window.addEventListener('beforeunload',()=>persist(true));
setInterval(()=>{ if(tapBuffer>0) persist(); },5000);

</script>
</body>
</html>
