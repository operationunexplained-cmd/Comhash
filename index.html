<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hacker Tapper ‚Äî ComHash (Single File)</title>

<script type="text/javascript" src="https://cdn.tgads.space/assets/js/adexium-widget.min.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const adexiumWidget = new AdexiumWidget({wid: 'de78ddc3-cd12-4357-a6cf-8fe6c9155acc', adFormat: 'interstitial'});
        adexiumWidget.autoMode();
    });
</script>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script src="//libtl.com/sdk.js" data-zone="10199103" data-sdk="show_10199103"></script>

<style>
:root{--bg:#020610;--card:#071425;--accent:#00e5a8;--muted:#93b6c6}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#001018,#020610);color:#d8f6f0}
.wrap{max-width:920px;margin:12px auto;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px}
@media(max-width:780px){.grid{grid-template-columns:1fr}}
.hud{display:flex;gap:8px;justify-content:space-between;margin-bottom:10px}
.stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;min-width:0}
#tapBtn{width:100%;padding:16px;border-radius:12px;background:linear-gradient(180deg,#023c32,#01513f);border:0;color:#fff;font-weight:800;font-size:18px}
.small{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px;border-radius:8px;cursor:pointer}
#hackAnim{height:140px;background:#00121a;border-radius:8px;padding:10px;color:#7ef2d7;overflow:auto;font-family:monospace}
.lb{max-height:420px;overflow:auto}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071021;padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);z-index:10000;max-width:92%;width:420px}
.closeX{position:absolute;right:8px;top:6px;cursor:pointer;color:var(--muted)}
#glitch{position:fixed;inset:0;display:none;z-index:9999;pointer-events:none}
.glitchLayer{width:100%;height:100%;background:linear-gradient(90deg, rgba(255,0,120,0.06), rgba(0,255,200,0.06));mix-blend-mode:screen;filter:contrast(1.2) saturate(1.2);animation:glitchAnim .8s ease-in-out}
@keyframes glitchAnim{0%{transform:translateX(0)}50%{transform:translateX(6px) skewX(-2deg)}100%{transform:translateX(0)}}
.muted{color:var(--muted);font-size:13px}
.pending{color:#ffd166;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h2 style="margin:.2rem 0">üíª Hacker Tapper ‚Äî ComHash</h2>
      <div class="muted">Tap, watch, invite, win ‚Äî inside Telegram</div>
    </div>
    <div id="playerTag" class="muted">Loading...</div>
  </div>

  <div class="card grid">
    <main id="left">
      <div class="hud">
        <div class="stat">Balance: <strong id="balance">0</strong> TOK</div>
        <div class="stat">Score: <strong id="score">0</strong></div>
        <div class="stat">Taps: <strong id="taps">0</strong></div>
      </div>

      <div id="hackAnim" class="card" aria-live="polite"></div>

      <button id="tapBtn">TAP TO INJECT</button>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="small" id="watchAdBtn">Watch Ad (reward)</button>
        <button class="small" id="missionsBtn">Missions</button>
        <button class="small" id="inviteBtn">Invite</button>
      </div>

      <div style="margin-top:12px" class="muted">Referral: <span id="refLink">-</span></div>
      <div style="margin-top:8px"><span id="adStatus" class="muted"></span></div>
    </main>

    <aside id="right">
      <div>
        <h3 style="margin:0">Leaderboard (Top 100)</h3>
        <div class="card lb" id="leaderboard"><ol id="lbList"></ol></div>

        <div style="margin-top:12px"><strong>Booster:</strong> <span id="boosterInfo">None</span></div>

        <div style="margin-top:12px"><strong>Recent Loot:</strong>
          <div id="lootList" class="muted" style="max-height:120px;overflow:auto"></div>
        </div>
      </div>
    </aside>
  </div>

  <div id="glitch"><div class="glitchLayer"></div></div>
  <div id="modalRoot"></div>
  <div class="muted" style="margin-top:10px">Host over HTTPS and open inside Telegram WebApp for best experience.</div>
</div>

<script>
/* ------------------- CONFIG -------------------
   Replace FIREBASE_CONFIG with your own if needed.
   MoneyTag SDK is already included via script tag above.
------------------------------------------------*/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBDovmAk88JUEjeY35T-3eIta1igiE5fQ0",
  authDomain: "comhashgame.firebaseapp.com",
  databaseURL: "https://comhashgame-default-rtdb.firebaseio.com",
  projectId: "comhashgame",
  storageBucket: "comhashgame.appspot.com",
  messagingSenderId: "392187080052",
  appId: "1:392187080052:web:3e31391442ca1315dc1021"
};
const MONEYTAG_FUNC = 'show_10199103'; // function name created by the MoneyTag script
/* ---------------------------------------------- */

function $id(id){ return document.getElementById(id); }
function createNode(tag, attrs={}){ const el=document.createElement(tag); Object.assign(el, attrs); return el; }

/* ----------------- Initialize Firebase RTDB ----------------- */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();
const usersRef = rdb.ref('users');
const lootRef = rdb.ref('lootHistory');

/* ----------------- Telegram WebApp ----------------- */
const tg = window.Telegram?.WebApp || null;
try { tg?.expand?.(); } catch(e){}
const tgUser = tg?.initDataUnsafe?.user || {};
const playerId = String(tgUser?.id || ('guest_' + Math.random().toString(36).slice(2,9)));
const playerName = (tgUser?.first_name) ? tgUser.first_name : 'Guest';
// $id('playerTag').textContent = `${playerName} ‚Ä¢ ${playerId}`; // Original line

/* referral (optional) */
const startParam = tg?.initDataUnsafe?.start_param || null;
let referrerId = (startParam && startParam.startsWith('ref_')) ? startParam.replace('ref_','') : null;

/* ----------------- State ----------------- */
let balance = 0; 
let score = 0;   
let totalTaps = 0; 
let tapBuffer = 0;
let booster = { multiplier:1, expiresAt:0 };
let recentLoot = [];
let lastAdPending = null;

/* ----------------- UI Helpers ----------------- */
function render(){
  // ‚≠êÔ∏è ADDED ID DISPLAY FOR DEBUGGING ‚≠êÔ∏è
  const displayId = (playerId.length > 10) ? playerId.slice(0, 8) + '...' : playerId;
  $id('playerTag').textContent = `${playerName} ‚Ä¢ ID: ${displayId}`; 
  // ‚≠êÔ∏è END ID DISPLAY ‚≠êÔ∏è

  $id('balance').textContent = balance;
  $id('score').textContent = score;
  $id('taps').textContent = totalTaps;
  $id('boosterInfo').textContent = (booster.multiplier>1 && Date.now()<booster.expiresAt) ? `x${booster.multiplier} (exp ${new Date(booster.expiresAt).toLocaleTimeString()})` : 'None';
  $id('refLink').textContent = `https://t.me/comhash_bot?start=ref_${playerId}`;
  $id('lootList').innerHTML = recentLoot.slice().reverse().map(l=>`<div>${new Date(l.ts).toLocaleTimeString()}: +${l.amount} TOK (${l.reason})</div>`).join('');
}

function pushLine(text){
  const el = createNode('div'); el.textContent = text;
  $id('hackAnim').appendChild(el);
  while($id('hackAnim').children.length > 8) $id('hackAnim').removeChild($id('hackAnim').firstChild);
}
function showModal(title, html){ const m=createNode('div'); m.className='modal'; m.innerHTML=`<div class="closeX">‚úï</div><h3>${title}</h3><div style="margin-top:8px">${html}</div>`; $id('modalRoot').appendChild(m); m.querySelector('.closeX').onclick = ()=>m.remove(); return m; }
function showGlitch(ms=800){ const g=$id('glitch'); g.style.display='block'; setTimeout(()=>g.style.display='none', ms); }

/* ----------------- Ensure user exists in RTDB ----------------- */
async function ensureUser(){
  
  // ‚≠êÔ∏è DEBUG LOG ‚≠êÔ∏è
  console.log('DEBUG 1: Player ID attempt:', playerId);
  
  try{
    const snap = await usersRef.child(playerId).get();
    
    if (!snap.exists()){
      // New user: Write default state to DB
      await usersRef.child(playerId).set({
        playerId, username: playerName, balance: 0, score: 0, totalTaps: 0, createdAt: Date.now(), referrer: referrerId || null
      });
      if (referrerId) await applyReferral(referrerId);
      // ‚≠êÔ∏è DEBUG LOG ‚≠êÔ∏è
      console.log('DEBUG 2: New user created. Balance/Score:', 0, 0);
    } else {
      // Existing user: Load authoritative state from DB
      const d = snap.val();
      balance = Number(d.balance || 0); 
      score = Number(d.score || 0); 
      totalTaps = Number(d.totalTaps || 0);
      if (d.booster && d.booster.expiresAt && Date.now() < d.booster.expiresAt) booster = d.booster;
      // load recent loot
      const lootSnap = await lootRef.orderByChild('playerId').equalTo(playerId).limitToLast(6).get();
      recentLoot = []; lootSnap.forEach(s=>recentLoot.push(s.val()));
      // ‚≠êÔ∏è DEBUG LOG ‚≠êÔ∏è
      console.log('DEBUG 2: Existing user loaded. Balance/Score:', balance, score);
    }
    
    // Render only after loading/creating user data from the authoritative source
    render();
  } catch(e){ 
    // ‚≠êÔ∏è DEBUG LOG ‚≠êÔ∏è
    console.error('DEBUG 3: DB error, falling back to local storage. Error:', e.message); 
    
    // Fallback: If DB query fails, load from localStorage
    balance = Number(localStorage.getItem('ht_balance') || 0);
    score = Number(localStorage.getItem('ht_score') || 0);
    totalTaps = Number(localStorage.getItem('ht_totalTaps') || 0);
    render();
  }
}
async function applyReferral(refId){
  try{
    const mySnap = await usersRef.child(playerId).get();
    if (!mySnap.exists) return;
    if (mySnap.val().referral_claimed) return;
    await usersRef.child(playerId).update({ referral_claimed:true });
    balance += 50; await usersRef.child(playerId).update({ balance });
    const refSnap = await usersRef.child(refId).get();
    if (refSnap.exists()){
      const prev = Number(refSnap.val().balance || 0);
      await usersRef.child(refId).update({ balance: prev + 100 });
    }
    render();
  } catch(e){ console.error('applyReferral', e); }
}
ensureUser();

/* ----------------- Persist local -> RTDB ----------------- */
async function persist(force=false){
  localStorage.setItem('ht_balance', String(balance));
  localStorage.setItem('ht_score', String(score));
  localStorage.setItem('ht_totalTaps', String(totalTaps));
  if (tapBuffer >= 20 || force){
    tapBuffer = 0;
    try {
      await usersRef.child(playerId).update({ balance, score, totalTaps, booster:(booster.multiplier>1?booster:null) });
    } catch(e){ console.warn('persist error', e); }
  }
}
setInterval(()=>persist(true), 15000);

/* ----------------- Leaderboard Top 100 (real-time) ----------------- */
/* RTDB trick: orderByChild('balance').limitToLast(100) gives last 100 by balance; we then reverse for descending */
usersRef.orderByChild('balance').limitToLast(100).on('value', snap=>{
  const arr = [];
  snap.forEach(s => arr.push(s.val()));
  arr.reverse();
  $id('lbList').innerHTML = '';
  arr.forEach((u,i)=>{
    const li = createNode('li');
    li.textContent = `${i+1}. ${u.username || u.playerId} ‚Äî ${Number(u.balance || 0)} TOK`;
    $id('lbList').appendChild(li);
  });
});

/* ----------------- Grant loot & booster helpers ----------------- */
async function grantLoot(amount, reason='event'){
  // update client state for immediate feedback and write to db
  balance += amount;
  recentLoot.push({ amount, reason, ts: Date.now() });
  if (recentLoot.length>12) recentLoot.shift();
  render();
  try {
    await lootRef.push({ playerId, amount, reason, ts: Date.now() });
    await usersRef.child(playerId).update({ balance });
  } catch(e){ console.warn('grantLoot err', e); }
}

async function giveBooster(mult, durSeconds){
  booster = { multiplier: mult, expiresAt: Date.now() + durSeconds*1000 };
  try { await usersRef.child(playerId).update({ booster }); } catch(e){ console.warn('booster update', e); }
  render();
  setTimeout(()=>{ if (Date.now() >= booster.expiresAt){ booster = { multiplier:1, expiresAt:0 }; render(); } }, durSeconds*1000 + 200);
}

/* ----------------- MoneyTag ad flow (client-side reward) ----------------- */
function injectMoneyTag(){
  // SDK already included via script tag, but ensure presence
  if (window[MONEYTAG_FUNC] && typeof window[MONEYTAG_FUNC] === 'function') {
    console.log('MoneyTag SDK available');
    return;
  }
  // Otherwise ensure we try to load (script tag already there normally)
  const script = document.querySelector('script[data-sdk="show_10199103"]');
  if (!script){
    const s = createNode('script');
    s.src = '//libtl.com/sdk.js';
    s.dataset.zone = '10199103';
    s.dataset.sdk = 'show_10199103';
    s.onload = ()=>console.log('MoneyTag loaded');
    s.onerror = ()=>console.warn('MoneyTag failed to load');
    document.head.appendChild(s);
  }
}
injectMoneyTag();

/* show MoneyTag ad. If MoneyTag supports object callbacks (onReward/onClose/onError) we'll use them.
   Otherwise we call the function and ask user to confirm (test fallback). */
async function showAdFlow(){
  const fn = window[MONEYTAG_FUNC];
  $id('adStatus').textContent = '';
  if (typeof fn === 'function'){
    // If SDK supports callback signature, try passing callbacks.
    try {
      let rewarded = false;
      // some MoneyTag versions accept an object with callbacks; try that first
      try {
        fn({
          onReward: async () => {
            rewarded = true;
            // grant reward when SDK calls onReward
            await grantLoot(50, 'ad_reward');
            $id('adStatus').textContent = 'Ad reward granted.';
          },
          onClose: ()=> {
            if (!rewarded) $id('adStatus').textContent = 'Ad closed (no reward).';
          },
          onError: (err)=> {
            console.warn('MoneyTag SDK error', err);
            $id('adStatus').textContent = 'Ad error.';
          }
        });
        // If above didn't throw but callbacks may not fire immediately, return 'requested'
        return 'requested';
      } catch(e){
        // SDK didn't accept callbacks ‚Äî fallback to calling directly
        console.log('MoneyTag call with callbacks failed - fallback', e);
        fn(); // open ad UI
        // Wait briefly and then request user confirmation (only fallback for testing)
        $id('adStatus').innerHTML = '<span class="pending">Ad open ‚Äî waiting for completion (confirm)...</span>';
        // Wait 1.5s then prompt confirmation
        await new Promise(r=>setTimeout(r, 1200));
        const ok = confirm('Mark ad as watched? (only use for testing ‚Äî real flow depends on SDK callbacks)');
        if (ok){
          await grantLoot(50, 'ad_reward_fallback');
          $id('adStatus').textContent = 'Ad reward granted (fallback confirmed).';
          return 'rewarded';
        } else {
          $id('adStatus').textContent = 'Ad skipped (fallback).';
          return 'skipped';
        }
      }
    } catch(err){
      console.warn('showAdFlow error', err);
      return 'skipped';
    }
  } else {
    // SDK unavailable
    alert('Ad SDK not loaded. Try again later.');
    return 'skipped';
  }
}

/* ----------------- Tap logic ----------------- */
/* ----------------- Tap logic (FIXED) ----------------- */
let sessionStart = 0, sessionTaps = 0;
$id('tapBtn').addEventListener('click', async ()=>{
  if (!sessionStart) sessionStart = Date.now();
  sessionTaps++; totalTaps++; tapBuffer++;
  const mult = (booster.multiplier>1 && booster.expiresAt > Date.now()) ? booster.multiplier : 1;
  const gain = Math.round(1 * mult + Math.random());
  score += gain;
  if (totalTaps % 5 === 0){
    const tok = Math.max(1, Math.floor(gain/1));
    balance += tok;
    recentLoot.push({ amount: tok, reason:'tap_reward', ts: Date.now() });
    if (recentLoot.length > 12) recentLoot.shift();
  }
  render();
  pushLine(`> injected +${gain} pts`);
  if (Math.random() < 0.03) showGlitch(700);
  if (Math.random() < 0.02){ const amt = Math.floor(Math.random()*50)+25; await grantLoot(amt,'random_drop'); }
  
  if (totalTaps % 30 === 0){
    // on 30 taps, run stacked actions
    await onThirty();
    // ‚ùå REMOVED: sessionStart = 0; 
    // ‚ùå REMOVED: sessionTaps = 0; 
  }
  if (tapBuffer >= 20) { await persist(); }
});


/* ----------------- 30-tap stacked actions ----------------- */
async function onThirty(){
  pushLine('!!! SYSTEM EVENT: 30 TAPS !!!');
  showGlitch(900);
  // auto-show MoneyTag ad
  const adResult = await showAdFlow();
  if (adResult === 'rewarded' || adResult === 'requested'){
    // if SDK will call back, booster will be applied when onReward fires.
    // Give a small immediate booster for UX if requested type
    await giveBooster(2, 20);
    const loot = Math.floor(Math.random()*150)+50;
    await grantLoot(loot,'30tap_bonus');
    showModal('30-tap Reward', `Booster x2 (20s) +${loot} TOK (ad may verify via SDK).`);
  } else {
    const small = 20; await grantLoot(small,'no_ad'); showModal('Notice', `No ad available ‚Äî you got ${small} TOK.`);
  }
}

/* ----------------- Missions UI ----------------- */
$id('missionsBtn').addEventListener('click', ()=>{
  const m = showModal('Mission', 'Claim 100 TOK for testing mission.<br><div style="margin-top:10px"><button id="claimBtn" class="small">Claim 100 TOK</button></div>');
  m.querySelector('#claimBtn').onclick = async ()=>{
    await grantLoot(100,'mission_claim');
    m.remove();
  };
});

/* ----------------- Watch Ad button ----------------- */
$id('watchAdBtn').addEventListener('click', async ()=>{
  const res = await showAdFlow();
  if (res === 'requested') showModal('Ad started', 'Ad started ‚Äî reward will be granted when SDK calls the reward callback.');
});

/* ----------------- Invite button ----------------- */
$id('inviteBtn').addEventListener('click', ()=>{
  const link = `https://t.me/comhash_bot?start=ref_${playerId}`;
  navigator.clipboard?.writeText(link).then(()=> alert('Referral link copied'), ()=> alert(link));
});

/* ----------------- Listen for DB changes to update UI (authoritative) ----------------- */
/* Keep user's data in sync with server writes so if another client updates balance it shows here */
usersRef.child(playerId).on('value', snap=>{
  if (!snap.exists()) return;
  const d = snap.val();
  // update local state from DB authoritative values
  balance = Number(d.balance || balance);
  score = Number(d.score || score);
  totalTaps = Number(d.totalTaps || totalTaps);
  if (d.booster && d.booster.expiresAt && Date.now() < d.booster.expiresAt) booster = d.booster;
  render();
});

/* Also listen to recent loot updates for this user (optional) */
lootRef.orderByChild('playerId').equalTo(playerId).limitToLast(12).on('value', snap=>{
  const arr = [];
  snap.forEach(s => arr.push(s.val()));
  arr.sort((a,b)=>b.ts-a.ts);
  recentLoot = arr;
  render();
});

/* ----------------- cleanup / persist ----------------- */
window.addEventListener('beforeunload', ()=> persist(true));
setInterval(()=>{ if (tapBuffer>0) persist(); }, 5000);

</script>
</body>
</html>
